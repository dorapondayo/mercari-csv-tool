<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„É°„É´„Ç´„É™CSVÁîüÊàê„ÉÑ„Éº„É´ v4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/encoding-japanese@2.0.0/encoding.min.js"></script>
  <style>
    .drag-over { border-color: #3b82f6 !important; background: #eff6ff !important; }
    /* ÂÜôÁúüÊåØ„ÇäÂàÜ„Åë„É¢„Éº„Éâ */
    .sorter-overlay { position:fixed; inset:0; background:#1a1a2e; z-index:300; display:flex; flex-direction:column; }
    .sorter-header { background:#16213e; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #0f3460; }
    .sorter-header h2 { color:#e94560; font-size:18px; font-weight:bold; }
    .sorter-stats { display:flex; gap:16px; font-size:14px; color:#eee; }
    .sorter-stat { background:#0f3460; padding:4px 12px; border-radius:16px; }
    .sorter-stat b { color:#e94560; }
    .sorter-toolbar { background:#16213e; padding:8px 16px; display:flex; gap:8px; align-items:center; border-bottom:1px solid #0f3460; flex-wrap:wrap; }
    .sorter-toolbar .sbtn { padding:6px 16px; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; transition:all 0.2s; }
    .sbtn-split { background:#e94560; color:#fff; } .sbtn-split:hover { background:#ff6b81; }
    .sbtn-undo { background:#444; color:#ddd; } .sbtn-undo:hover { background:#555; }
    .sbtn-done { background:#28a745; color:#fff; font-size:15px; padding:8px 24px; } .sbtn-done:hover { background:#34d058; }
    .sbtn-done:disabled { background:#555; cursor:not-allowed; }
    .sbtn-cancel { background:#666; color:#fff; } .sbtn-cancel:hover { background:#777; }
    .sorter-grid { flex:1; overflow-y:auto; padding:10px; display:flex; flex-wrap:wrap; gap:6px; align-content:flex-start; }
    .sorter-item { width:120px; height:120px; position:relative; cursor:pointer; border-radius:6px; overflow:hidden; border:3px solid transparent; background:#222; user-select:none; transition:border-color 0.15s; }
    .sorter-item img { width:100%; height:100%; object-fit:cover; pointer-events:none; }
    .sorter-item.s-selected { border-color:#00bfff; }
    .sorter-item.s-split { border-color:#e94560; }
    .sorter-item.s-split::after { content:"‚úÇ"; position:absolute; top:2px; right:4px; background:#e94560; color:#fff; font-size:12px; padding:2px 6px; border-radius:4px; pointer-events:none; }
    .sorter-item .s-label { position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); font-size:9px; text-align:center; padding:2px; color:#ccc; pointer-events:none; }
    .sorter-divider { width:100%; padding:4px 10px; background:#e94560; color:#fff; font-weight:bold; font-size:13px; border-radius:4px; margin:4px 0; display:flex; justify-content:space-between; }
    .sorter-sidebar { width:180px; background:#16213e; overflow-y:auto; border-right:1px solid #0f3460; flex-shrink:0; }
    .sorter-pc-item { padding:8px 12px; cursor:pointer; border-bottom:1px solid #0f3460; display:flex; justify-content:space-between; color:#eee; font-size:13px; transition:background 0.2s; }
    .sorter-pc-item:hover { background:#1a1a40; }
    .sorter-pc-item.s-active { background:#0f3460; border-left:3px solid #e94560; }
    .sorter-preview { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:400; justify-content:center; align-items:center; cursor:pointer; }
    .sorter-preview.active { display:flex; }
    .sorter-preview img { max-width:90%; max-height:90%; object-fit:contain; }
    .sorter-keys { font-size:12px; color:#888; margin-left:auto; }
    .sorter-keys kbd { background:#333; padding:2px 6px; border-radius:4px; border:1px solid #555; font-family:monospace; color:#ddd; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useCallback, useEffect } = React;

// Ë®≠ÂÆö
const CONFIG = {
  category_macbook: '9taHgBE3YAkhXLEpvShiYc',
  category_windows: 'FUdk7W2MDA6tujBfXCjgr4',
  shipping_method: 3,        // ÈÖçÈÄÅÊñπÊ≥ïÔºà3=„Çâ„Åè„Çâ„Åè„É°„É´„Ç´„É™‰æøÔºâ
  region: 'jp14',            // Áô∫ÈÄÅÂÖÉÔºàjp14=Á•ûÂ•àÂ∑ùÁúåÔºâ
  shipping_days: 2,          // Áô∫ÈÄÅÊó•Êï∞Ôºà2=2~3Êó•„ÅßÁô∫ÈÄÅÔºâ
  shipping_fee: 1,           // ÈÖçÈÄÅÊñôË≤†ÊãÖÔºà1=ÈÄÅÊñôËæº„ÅøÔºâ
  condition_map: {           // ÂïÜÂìÅ„ÅÆÁä∂ÊÖã
    'Êñ∞ÂìÅ„ÄÅÊú™‰ΩøÁî®': 1,
    'Êú™‰ΩøÁî®„Å´Ëøë„ÅÑ': 2,
    'ÁõÆÁ´ã„Å£„ÅüÂÇ∑„ÇÑÊ±ö„Çå„Å™„Åó': 3,
    '„ÇÑ„ÇÑÂÇ∑„ÇÑÊ±ö„Çå„ÅÇ„Çä': 4,
    'ÂÇ∑„ÇÑÊ±ö„Çå„ÅÇ„Çä': 5,
    'ÂÖ®‰ΩìÁöÑ„Å´Áä∂ÊÖã„ÅåÊÇ™„ÅÑ': 6
  }
};

const CONDITION_MAP = {
  'A': 'ÁõÆÁ´ã„Å£„ÅüÂÇ∑„ÇÑÊ±ö„Çå„Å™„Åó', 'B': '„ÇÑ„ÇÑÂÇ∑„ÇÑÊ±ö„Çå„ÅÇ„Çä',
  'C': 'ÁõÆÁ´ã„Å£„ÅüÂÇ∑„ÇÑÊ±ö„Çå„Å™„Åó', 'D': '„ÇÑ„ÇÑÂÇ∑„ÇÑÊ±ö„Çå„ÅÇ„Çä', 'Z': 'ÂÖ®‰ΩìÁöÑ„Å´Áä∂ÊÖã„ÅåÊÇ™„ÅÑ'
};

const ACCESSORY_MAP = {
  'ÈõªÊ∫êÔΩ∫ÔΩ∞ÔæÑÔæû': 'AC„Ç≥„Éº„Éâ', 'ACÔΩ∫ÔΩ∞ÔæÑÔæû': 'AC„Ç≥„Éº„Éâ', 'AC„Ç≥„Éº„Éâ': 'AC„Ç≥„Éº„Éâ',
  'ACÔΩ±ÔæÄÔæûÔæåÔæüÔæÄ': 'AC„Ç¢„ÉÄ„Éó„Çø„Éº', 'ACÔΩ±ÔæÄÔæûÔæåÔæüÔæÄÔΩ∞': 'AC„Ç¢„ÉÄ„Éó„Çø„Éº', 'AC„Ç¢„ÉÄ„Éó„Çø„Éº': 'AC„Ç¢„ÉÄ„Éó„Çø„Éº',
  'MagSafe„Ç±„Éº„Éñ„É´': 'MagSafe„Ç±„Éº„Éñ„É´', 'USB-C-C„Ç±„Éº„Éñ„É´': 'USB-C„Ç±„Éº„Éñ„É´',
  'AC„Éó„É©„Ç∞': 'AC„Éó„É©„Ç∞', 'ÔæèÔΩ≥ÔΩΩ': '„Éû„Ç¶„Çπ', 'ÔΩ∑ÔΩ∞ÔæéÔæûÔΩ∞ÔæÑÔæû': '„Ç≠„Éº„Éú„Éº„Éâ'
};
const ACCESSORY_EXCLUDE = ['ÔæäÔæûÔΩØÔæÉÔæòÔæäÔæüÔΩØÔΩ∏', 'WebÔΩ∂ÔæíÔæóÊúâ', 'Ëã±Â≠óKB', 'TVÊ©üËÉΩ'];

const DEFAULT_NOTICE_TEXT = `‚Äª ÂÆüÈöõ„ÅÆÂïÜÂìÅÁîªÂÉè„Åß„Åô„ÄÇ
‚Äª „Çπ„Éö„ÉÉ„ÇØ„ÇÑÁä∂ÊÖã„ÅÆË©≥Á¥∞„ÅØÁîªÂÉè„Åã„Çâ„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ
‚Äª ‰∏≠Âè§ÂìÅ„ÅÆ„Åü„ÇÅ„ÄÅ‰ΩøÁî®„Å´Â∑Æ„ÅóÊîØ„Åà„Å™„ÅÑÂÇ∑„ÇÑÊ±ö„Çå„Åå„ÅÇ„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂøÖ„ÅöÂÜôÁúü„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ

‚ñ† ÂàùÊúü‰∏çËâØ„Å´„Å§„ÅÑ„Å¶
Âá∫Ëç∑Êó•„Åã„Çâ7Êó•‰ª•ÂÜÖ„Å´„ÅîÈÄ£Áµ°„ÅÑ„Åü„Å†„ÅÑ„ÅüÂàùÊúü‰∏çËâØÔºàÈõªÊ∫ê„ÅåÂÖ•„Çâ„Å™„ÅÑ„ÄÅÁîªÈù¢„ÅåÊò†„Çâ„Å™„ÅÑ„Å™„Å©Ôºâ„Å´„Å§„ÅÑ„Å¶„ÅØ„ÄÅÂΩìÂ∫ó„Å´„Å¶Âãï‰ΩúÁ¢∫Ë™ç„ÅÆ‰∏ä„ÄÅÁÑ°ÂÑü„Åß‰∫§Êèõ„Åæ„Åü„ÅØ‰øÆÁêÜÂØæÂøú„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ
„ÉªÂØæË±°ÊúüÈñìÔºöÂá∫Ëç∑Êó•„Åã„Çâ7Êó•Èñì
„ÉªÈÄÅÊñôÔºöÂæÄÂæ©„Åô„Åπ„Å¶ÂΩìÂ∫óË≤†ÊãÖ

‚ñ† ‰øùË®ºÂØæË±°Â§ñ
‰ª•‰∏ã„ÅÆÂ†¥Âêà„ÅØ‰øùË®º„ÉªËøîÂìÅ„ÅÆÂØæË±°Â§ñ„Åß„Åô„ÄÇ
„Éª„ÅäÂÆ¢Êßò„ÅÆÈÅéÂ§±„Å´„Çà„ÇãÊïÖÈöú„ÉªÁ†¥ÊêçÔºàÊ∞¥Êø°„Çå„ÉªËêΩ‰∏ã„ÉªË°ùÊíÉ„ÉªË™§Êé•Á∂ö„Å™„Å©Ôºâ
„ÉªÂàÜËß£„ÉªÊîπÈÄ†„Å´„Çà„Çã„Éà„É©„Éñ„É´
„Éª„ÅäÂÆ¢Êßò„ÅîËá™Ë∫´„Å´„Çà„ÇãOSÂÜç„Ç§„É≥„Çπ„Éà„Éº„É´Âæå„ÅÆ„Éà„É©„Éñ„É´
„Éª„ÇΩ„Éï„Éà„Ç¶„Çß„Ç¢„ÅÆ‰∏çÂÖ∑Âêà„ÄÅÂØæÂøú„Åó„Å™„ÅÑ„Ç≤„Éº„É†Á≠â„Å®„ÅÆÁõ∏ÊÄßÂïèÈ°å
„ÉªÂãï‰Ωú„Å´ÂΩ±Èüø„Åó„Å™„ÅÑËªΩÂæÆ„Å™Â§ñË¶≥‰∏ä„ÅÆÂÇ∑„ÇÑÊ±ö„Çå
„Éª„Éê„ÉÉ„ÉÜ„É™„Éº„ÅÆÂä£Âåñ„ÉªÊ∂àËÄó
‚Äª„ÄåÂàÜËß£„ÉªÊîπÈÄ†„Äç„Å´„Å§„ÅÑ„Å¶ÔºöÂΩìÂ∫ó„Åã„Çâ„ÅÆÊåáÁ§∫„Å™„ÅèÂÜÖÈÉ®„Éë„Éº„ÉÑ„Å∏„ÅÆ‰ΩúÊ•≠„ÇíË°å„Å£„ÅüÂ†¥Âêà„ÅØ‰øùË®ºÂØæË±°Â§ñ„Å®„Å™„Çä„Åæ„Åô„ÄÇ‰∏çÂÖ∑Âêà„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Åæ„ÅöÂΩìÂ∫ó„Å∏„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ

‚ñ† ‰∏çÂÖ∑Âêà„ÅÆ„ÅîÈÄ£Áµ°„Å´„Å§„ÅÑ„Å¶
‰∏çÂÖ∑Âêà„ÅÆÂÖ∑‰ΩìÁöÑ„Å™ÁóáÁä∂„ÉªÁô∫ÁîüÁä∂Ê≥Å„ÉªÂÜôÁúü„Åæ„Åü„ÅØÂãïÁîª„Çí„ÅîÊèê‰æõ„Åè„Å†„Åï„ÅÑ„ÄÇ
ÊÉÖÂ†±„Çí„ÅîÊèê‰æõ„ÅÑ„Åü„Å†„Åë„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÂØæÂøú„Çí„ÅäÊñ≠„Çä„Åô„Çã„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ

‚ÄªË©≤ÂΩì„ÅåÁñë„Çè„Çå„ÇãÂ†¥Âêà„ÅØ„ÄÅÁä∂Ê≥ÅÂÜôÁúü„ÇíÊ∑ª„Åà„Å¶‰∫ãÂâç„Å´„ÅîÈÄ£Áµ°„ÅÆ„ÅÜ„Åà„ÄÅÁùÄÊâï„ÅÑ„Åß„ÅîËøîÈÄÅ„Åè„Å†„Åï„ÅÑ„ÄÇ`;

// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
const normalizeMemory = (v) => {
  if (!v) return '';
  const str = String(v).toUpperCase();
  // MBË°®Ë®ò„ÅÆÂ†¥Âêà„ÅØGB„Å´Â§âÊèõ
  const mbMatch = str.match(/(\d+)\s*(MB|M)/i);
  if (mbMatch) {
    const mb = parseInt(mbMatch[1]);
    return `${Math.round(mb / 1024)}GB`;
  }
  // GBË°®Ë®ò
  const gbMatch = str.match(/(\d+)\s*(GB|G)?/i);
  if (gbMatch) {
    const n = parseInt(gbMatch[1]);
    // 1000‰ª•‰∏ä„ÅØMB„ÅÆÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ
    if (n >= 1000) return `${Math.round(n / 1024)}GB`;
    return `${n}GB`;
  }
  return v;
};

const normalizeStorage = (v) => {
  if (!v) return '';
  const str = String(v).toUpperCase();
  const m = str.match(/(\d+)\s*(G|GB|T|TB)?/i);
  if (m) {
    const n = parseInt(m[1]);
    const u = (m[2] || '').toUpperCase();
    return (u === 'T' || u === 'TB' || n <= 4) ? `${n}TB` : `${n}GB`;
  }
  return v;
};

// EMCÁï™Âè∑„Åã„ÇâMacÊÉÖÂ†±„ÇíÂèñÂæó„Åô„Çã„Éû„ÉÉ„Éî„É≥„Ç∞
const EMC_MAP = {
  // MacBook Pro 16"
  '3347': { size: '16', year: '2019' },
  '3651': { size: '16', year: '2021' },
  '4044': { size: '16', year: '2023' },
  // MacBook Pro 15"
  '3215': { size: '15', year: '2018' },
  '3162': { size: '15', year: '2017' },
  '3163': { size: '15', year: '2017' },
  '3072': { size: '15', year: '2016' },
  // MacBook Pro 14"
  '3598': { size: '14', year: '2021' },
  '4046': { size: '14', year: '2023' },
  // MacBook Pro 13"
  '3301': { size: '13', year: '2019' },
  '3214': { size: '13', year: '2018' },
  '3164': { size: '13', year: '2017' },
  '3071': { size: '13', year: '2016' },
  '3358': { size: '13', year: '2020' },
  '3578': { size: '13', year: '2020' }, // M1
  // MacBook Air 13"
  '3348': { size: '13', year: '2020' },
  '3598': { size: '13', year: '2020' }, // M1
  '3941': { size: '13', year: '2022' }, // M2
  // MacBook Air 15"
  '4043': { size: '15', year: '2023' },
};

const extractSpecs = (row) => {
  const s = { maker: '', product_name: '', cpu: '', memory: '', storage: '', display: '', gpu: '', model: '', size: '', year: '', chip: '' };
  if (!row) return s;
  
  s.maker = row['„É°„Éº„Ç´„Éº'] || '';
  s.product_name = (row['ÂïÜÂìÅÂêç'] || '').replace(/\([^)]*\)/g, '').trim();
  s.gpu = row['GPU'] || '';
  
  // MacÊÉÖÂ†±ÊäΩÂá∫
  const name = row['ÂïÜÂìÅÂêç'] || '';
  const cpu = row['CPU'] || '';
  const makerLower = s.maker.toLowerCase();
  const nameLower = name.toLowerCase();
  
  if (makerLower.includes('apple') || nameLower.includes('mac')) {
    // EMCÁï™Âè∑„Åã„ÇâÊÉÖÂ†±ÂèñÂæó
    const emcMatch = name.match(/EMC\s*(\d{4})/i);
    if (emcMatch && EMC_MAP[emcMatch[1]]) {
      const emcInfo = EMC_MAP[emcMatch[1]];
      s.size = emcInfo.size + '„Ç§„É≥„ÉÅ';
      s.year = emcInfo.year;
    }
    
    // modelÊäΩÂá∫ÔºàPro/Air/mini/iMacÔºâ
    if (/macbook\s*pro|m-?book\s*pro/i.test(name)) {
      s.model = 'MacBook Pro';
    } else if (/macbook\s*air|m-?book\s*air/i.test(name)) {
      s.model = 'MacBook Air';
    } else if (/mac\s*mini/i.test(name)) {
      s.model = 'Mac mini';
    } else if (/imac/i.test(name)) {
      s.model = 'iMac';
    } else if (/mac\s*pro/i.test(name)) {
      s.model = 'Mac Pro';
    } else {
      s.model = 'MacBook';
    }
    
    // sizeÊäΩÂá∫ÔºàEMC„Åã„ÇâÂèñÂæóÊ∏à„Åø„Åß„Å™„Åë„Çå„Å∞Ôºâ
    if (!s.size) {
      const nameForSize = name.replace(/\([^)]*\)/g, '');
      const sizeMatch = nameForSize.match(/(\d{2})[- ]?inch|(\d{2}(?:\.\d)?)[ÔΩ≤„Ç§]?Ôæù?ÔæÅ|(\d{2}(?:\.\d)?)„Ç§„É≥„ÉÅ/i);
      if (sizeMatch) {
        s.size = (sizeMatch[1] || sizeMatch[2] || sizeMatch[3]) + '„Ç§„É≥„ÉÅ';
      }
    }
    
    // yearÊäΩÂá∫ÔºàEMC„Åã„ÇâÂèñÂæóÊ∏à„Åø„Åß„Å™„Åë„Çå„Å∞Ôºâ
    if (!s.year) {
      const yearMatch = name.match(/\b(20[12]\d)\b/);
      if (yearMatch) {
        s.year = yearMatch[1];
      }
    }
    
    // year„Åå„Å™„Åë„Çå„Å∞CPUÂûãÁï™„Åã„ÇâÊé®Ê∏¨
    if (!s.year && cpu) {
      // Ice Lake MacÁî®Ôºà1000NG4, 1030NG7„Å™„Å©Ôºâ
      if (/10[0-9]{2}NG/i.test(cpu)) {
        s.year = '2020';
      } else {
        // Á¨¨10‰∏ñ‰ª£‰ª•ÈôçÔºà10xxx„Äú14xxxÔºâ
        let genMatch = cpu.match(/i[3579]-(1[0-4])\d{3}/i);
        if (genMatch) {
          const gen = parseInt(genMatch[1]);
          const yearMap = {10: '2020', 11: '2020', 12: '2021', 13: '2022', 14: '2023'};
          s.year = yearMap[gen] || '';
        } else {
          // Á¨¨4-9‰∏ñ‰ª£Ôºà4xxx„Äú9xxxÔºâ
          genMatch = cpu.match(/i[3579]-([4-9])\d{3}/i);
          if (genMatch) {
            const gen = parseInt(genMatch[1]);
            const yearMap = {4: '2013', 5: '2015', 6: '2016', 7: '2017', 8: '2018', 9: '2019'};
            s.year = yearMap[gen] || '';
          }
        }
      }
    }
    
    // chipÊäΩÂá∫ÔºàM1/M2/M3/M4„Å™„Å©„ÄÅM1P=M1 Pro„Å™„Å©Áü≠Á∏ÆÂΩ¢„ÇÇÂØæÂøúÔºâ
    const chipMatch = cpu.match(/\b(M[1-4](?:\s*(?:Pro|Max|Ultra))?)\b/i) || cpu.match(/\b(M[1-4]P)\b/i);
    if (chipMatch) {
      let chip = chipMatch[1];
      // Áü≠Á∏ÆÂΩ¢„ÇíÂ±ïÈñã
      chip = chip.replace(/^M(\d)P$/i, 'M$1 Pro');
      s.chip = chip;
    }
  }
  
  // Â∞ÇÁî®Âàó„Åå„ÅÇ„Çå„Å∞ÂÑ™ÂÖà
  if (row['„É°„É¢„É™']) s.memory = normalizeMemory(row['„É°„É¢„É™']);
  if (row['„Çπ„Éà„É¨„Éº„Ç∏']) s.storage = normalizeStorage(row['„Çπ„Éà„É¨„Éº„Ç∏']);
  if (row['„Éá„Ç£„Çπ„Éó„É¨„Ç§„Çµ„Ç§„Ç∫']) {
    const d = row['„Éá„Ç£„Çπ„Éó„É¨„Ç§„Çµ„Ç§„Ç∫'].replace(/[ÔΩ≤ÔæùÔæÅ„Ç§„É≥„ÉÅÂûã]/g, '').trim();
    if (d) s.display = `${d}„Ç§„É≥„ÉÅ`;
  }
  
  // CPUÂàó„ÇíËß£Êûê
  if (cpu) {
    const p = cpu.split('/');
    s.cpu = p[0]?.trim() || '';
    
    // CPUÂàó„Åã„ÇâGPUÊäΩÂá∫
    p.forEach(x => { if (/RTX|GTX|MX\d/i.test(x) && !s.gpu) s.gpu = x.trim(); });
    
    // Â∞ÇÁî®Âàó„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÄÅCPUÂàó„Åã„ÇâÊäΩÂá∫
    if (!s.memory && p[1]) s.memory = normalizeMemory(p[1].trim());
    if (!s.storage && p[2]) s.storage = normalizeStorage(p[2].trim());
    if (!s.display && p[3]) {
      const d = p[3].replace(/[ÔΩ≤ÔæùÔæÅ„Ç§„É≥„ÉÅÂûã]/g, '').trim();
      if (d) s.display = `${d}„Ç§„É≥„ÉÅ`;
    }
    
    // MacÁî®: size„Åå„Åæ„Å†Á©∫„Å™„ÇâCPUÂàó„Åã„ÇâÂèñÂæó
    if (!s.size && p[3]) {
      const sizeFromCpu = p[3].match(/(\d{2}(?:\.\d)?)/);
      if (sizeFromCpu) s.size = sizeFromCpu[1] + '„Ç§„É≥„ÉÅ';
    }
  }
  
  return s;
};

const detectProductType = (row, specs) => {
  const m = (specs.maker || '').toLowerCase();
  const n = (row['ÂïÜÂìÅÂêç'] || '').toLowerCase();
  const c = row['CPU'] || '';
  if (m.includes('apple') || n.includes('mac')) {
    // M1/M2/M3/M4„ÄÅ„Åæ„Åü„ÅØM1P/M2P„Å™„Å©Áü≠Á∏ÆÂΩ¢
    return /\bM[1-4]\b|^M[1-4]P?\b/i.test(c) ? 'apple_silicon' : 'intel_mac';
  }
  return 'windows';
};

const parseAccessories = (str) => {
  if (!str) return [];
  const r = [];
  str.split(/[\s/]+/).forEach(p => {
    if (ACCESSORY_EXCLUDE.some(e => p.includes(e))) return;
    for (const [k, v] of Object.entries(ACCESSORY_MAP)) {
      if (p.includes(k) && !r.includes(v)) { r.push(v); break; }
    }
  });
  return r;
};

// „É©„É≥„ÇØ„ÇíÊó•Êú¨Ë™û„Å´Â§âÊèõ
const RANK_DISPLAY = {
  'A': 'ÁæéÂìÅ',
  'B': 'ÁæéÂìÅ',
  'C': 'ËâØÂìÅ',
  'D': 'ÂÇ∑„ÅÇ„Çä',
  'E': '„Ç∏„É£„É≥„ÇØ'
};

// „Çø„Ç§„Éà„É´Áî®CPUË°®Ë®ò„ÇØ„É™„Éº„É≥ÔºàCi5-1.3G-1335U ‚Üí Core i5-1335UÔºâ
const cleanCpuForTitle = (cpu) => {
  if (!cpu) return '';
  let c = cpu;
  // Âë®Ê≥¢Êï∞„ÇíÈô§Âéª: -1.7G-, -2.3G, 1.60GHzÁ≠â
  c = c.replace(/-[\d.]+G(?=-|$)/g, '');  // -1.7G- ÂΩ¢Âºè
  c = c.replace(/\s*[\d.]+\s*GHz/i, '');   // 1.60GHz ÂΩ¢Âºè
  // Ci3/Ci5/Ci7/Ci9 ‚Üí Core i3/i5/i7/i9
  c = c.replace(/^Ci(\d)/i, 'Core i$1');
  // Corei5 ‚Üí Core i5Ôºà„Çπ„Éö„Éº„ÇπÊåøÂÖ•Ôºâ
  c = c.replace(/^Corei(\d)/i, 'Core i$1');
  // Core i5- Á≠â„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Çí„Çπ„Éö„Éº„Çπ„Å´ÔºàCore i5-10310U ‚Üí Core i5 10310UÔºâ
  c = c.replace(/^(Core\s*i\d)\s*-\s*/i, '$1 ');
  // ‰∫åÈáç„ÉÄ„ÉÉ„Ç∑„É•„ÉªÊú´Â∞æ„ÉÄ„ÉÉ„Ç∑„É•Êï¥ÁêÜ
  c = c.replace(/--+/g, '-').replace(/^-|-$/g, '');
  return c.trim();
};

const makeTitle = (p) => {
  const s = p.specs || {};
  const t = p.product_type;
  // „Ç∏„É£„É≥„ÇØÂìÅ„ÅÆÂ†¥Âêà„ÅØ„Äê„Ç∏„É£„É≥„ÇØ„Äë„ÅÆ„Åø„ÄÅÈÄöÂ∏∏„ÅØ„Äê„É©„É≥„ÇØ„Äë„Äê1ÈÄ±Èñì‰øùË®º„Äë
  let prefix;
  if (p.isJunk) {
    prefix = '„Äê„Ç∏„É£„É≥„ÇØ„Äë';
  } else {
    const rankJp = RANK_DISPLAY[p.rank] || 'ËâØÂìÅ';
    prefix = `„Äê${rankJp}„Äë„Äê1ÈÄ±Èñì‰øùË®º„Äë`;
  }
  const parts = [prefix];
  if (t === 'intel_mac' || t === 'apple_silicon') {
    parts.push(`${s.model || 'MacBook'} ${s.size || ''}`);
    if (s.year) parts.push(String(s.year));
    if (t === 'apple_silicon' && s.chip) parts.push(s.chip);
    else if (s.cpu) {
      parts.push(cleanCpuForTitle(s.cpu));
    }
    if (s.memory) parts.push(s.memory);
    if (s.storage) parts.push(s.storage);
  } else {
    if (s.maker) parts.push(s.maker.replace('mouse computer', 'mouse'));
    if (s.cpu) {
      parts.push(cleanCpuForTitle(s.cpu));
    }
    if (s.memory) parts.push(s.memory);
    if (s.storage) parts.push(s.storage);
    if (s.display) parts.push(s.display);
    // Â§ñ‰ªò„ÅëGPU„ÅÆ„ÅøË°®Á§∫ÔºàRTX/GTX/MX/Radeon/GeForceÔºâ„ÄÅÂÜÖËîµGPU(Intel/LakeÁ≥ª)„ÅØÈô§Â§ñ
    if (s.gpu && /RTX|GTX|MX\d|Radeon|GeForce/i.test(s.gpu)) parts.push(s.gpu);
    parts.push('Win11');
  }
  let title = parts[0] + parts.slice(1).join(' / ');
  return title.length > 65 ? title.slice(0, 62) + '...' : title;
};

// „Ç∏„É£„É≥„ÇØÂìÅÁî®„ÅÆÁä∂ÊÖã„ÉÜ„Ç≠„Çπ„Éà
const JUNK_STATE_TEXT = `Êú¨ÂïÜÂìÅ„ÅØ„Ç∏„É£„É≥„ÇØÂìÅ„ÅÆ„Åü„ÇÅ„ÄÅÂãï‰Ωú„ÉªÁä∂ÊÖã„ÉªÈÉ®ÂìÅ„ÅÆÊ¨†ÂìÅ„Çí‰∏ÄÂàá‰øùË®º„Åó„Åæ„Åõ„Çì„ÄÇ
Ëµ∑Âãï‰∏çÂèØ„ÉªÁîªÈù¢‰∏çËâØ„ÉªÁï∞Èü≥„ÉªÁ´ØÂ≠ê‰∏çËâØ„Éª„Éê„ÉÉ„ÉÜ„É™„ÉºÂä£Âåñ„ÉªÂ§ñË£ÖÁ†¥Êêç„Å™„Å©„ÄÅ„ÅÑ„Åã„Å™„Çã‰∏çÂÖ∑Âêà„Åß„ÇÇËøîÂìÅ„ÉªËøîÈáë„Éª‰∫§Êèõ‰∏çÂèØ„Å®„Å™„Çä„Åæ„Åô„ÄÇ
‰øÆÁêÜ„ÉªÈÉ®ÂìÅÂèñ„ÇäÂâçÊèê„Åß„ÅîË≥ºÂÖ•„Åè„Å†„Åï„ÅÑ„ÄÇ`;

const makeDescription = (p, customNotice) => {
  const s = p.specs || {};
  const t = p.product_type;
  // ÂûãÁï™„Åã„Çâ„Äå‰ªñ XÂè∞„Çª„ÉÉ„Éà„Äç„ÇíÂâäÈô§
  const modelClean = (s.product_name || '-').replace(/‰ªñ?\s*\d+Âè∞[ÔΩæ„Çª][ÔΩØ„ÉÉ][ÔæÑ„Éà]/g, '').trim() || '-';
  const lines = [];
  if (t === 'intel_mac' || t === 'apple_silicon') {
    lines.push(`„É¢„Éá„É´Ôºö${s.model || 'MacBook'} ${s.year || ''}`);
    if (t === 'apple_silicon') lines.push(`„ÉÅ„ÉÉ„ÉóÔºöApple ${s.chip || ''}`);
    else lines.push(`CPUÔºö${s.cpu || '-'}`);
    if (s.gpu) lines.push(`GPUÔºö${s.gpu}`);
    lines.push(`„É°„É¢„É™Ôºö${s.memory || '-'}`, `„Çπ„Éà„É¨„Éº„Ç∏Ôºö${s.storage || '-'}`, `„Éá„Ç£„Çπ„Éó„É¨„Ç§Ôºö${s.size || '-'}`);
    if (p.cycle_count) lines.push(`ÂÖÖÊîæÈõªÂõûÊï∞Ôºö${p.cycle_count}Âõû`);
    if (p.battery_health) lines.push(`„Éê„ÉÉ„ÉÜ„É™„ÉºÊúÄÂ§ßÂÆπÈáèÔºö${p.battery_health}%`);
    lines.push(`ÂàùÊúüË®≠ÂÆö„Éë„Çπ„ÉØ„Éº„ÉâÔºö0000`);
  } else {
    lines.push(`„É°„Éº„Ç´„ÉºÔºö${s.maker || '-'}`, `ÂûãÁï™Ôºö${modelClean}`, `CPUÔºö${s.cpu || '-'}`);
    if (s.gpu) lines.push(`GPUÔºö${s.gpu}`);
    lines.push(`„É°„É¢„É™Ôºö${s.memory || '-'}`, `„Çπ„Éà„É¨„Éº„Ç∏Ôºö${s.storage || '-'}`, `„Éá„Ç£„Çπ„Éó„É¨„Ç§Ôºö${s.display || '-'}`, 'OSÔºöWindows 11');
    if (p.hasOffice) lines.push('OfficeÔºöMicrosoft Office2024(Ê∞∏Á∂öÁâà)Êê≠Ëºâ\n‚áíword,excel,PowerPointÁ≠âÂà©Áî®ÂèØËÉΩ');
  }
  if (p.is_english_kb) lines.push('„Ç≠„Éº„Éú„Éº„ÉâÔºöËã±Â≠óÈÖçÂàó');
  const spec = '„Äê„Çπ„Éö„ÉÉ„ÇØ„Äë\n' + lines.join('\n');
  const acc = `„Äê‰ªòÂ±ûÂìÅ„Äë\n${(p.accessories || []).join('„ÄÅ')}`;
  // „Ç∏„É£„É≥„ÇØÂìÅ„ÅÆÂ†¥Âêà„ÅØÂ∞ÇÁî®„ÉÜ„Ç≠„Çπ„Éà„ÄÅÈÄöÂ∏∏„ÅØÁëïÁñµÊÉÖÂ†±
  const stateContent = p.isJunk ? JUNK_STATE_TEXT : (p.defect_info || '');
  const state = `„ÄêÁä∂ÊÖã„Äë\n${stateContent}`;
  // „Ç∏„É£„É≥„ÇØÂìÅ„ÅÆÂ†¥Âêà„ÅØNOTICE_TEXT„ÇíÁúÅÁï•
  const notice = p.isJunk ? '' : (customNotice || DEFAULT_NOTICE_TEXT);
  return `${p.barcode || ''}\n\n${p.intro || ''}\n\n${spec}\n\n${acc}\n\n${state}${notice ? '\n\n' + notice : ''}`;
};

// OpenAI APIÔºàÈÅ∏Êäû„Åó„Åü„É¢„Éá„É´„Çí‰ΩøÁî®Ôºâ
const callOpenAI = async (key, msgs, max = 200) => {
  const model = localStorage.getItem('openai_model') || 'gpt-4o';
  // Êñ∞„Åó„ÅÑ„É¢„Éá„É´Ôºà4.1Á≥ª„ÄÅ5Á≥ª„ÄÅo1„ÄÅo3„Å™„Å©Ôºâ„ÅØmax_completion_tokens
  const useNewParam = model.includes('4.1') || model.startsWith('gpt-5') || model.startsWith('o1') || model.startsWith('o3');
  const body = {
    model,
    messages: msgs,
    ...(useNewParam ? { max_completion_tokens: max } : { max_tokens: max })
  };
  const r = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
    body: JSON.stringify(body)
  });
  const d = await r.json();
  if (d.error) throw new Error(d.error.message);
  return d.choices[0].message.content.trim();
};

// OCR
const ocrBarcode = async (key, dataUrl) => {
  const base64 = dataUrl.split(',')[1];
  const media = dataUrl.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
  const result = await callOpenAI(key, [{
    role: 'user',
    content: [
      { type: 'text', text: '„Åì„ÅÆÁîªÂÉè„Å´„ÅÇ„ÇãÊï∞Â≠ó„ÅÆ‰∏ã6Ê°Å„ÇíËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÄËøîÁ≠î„ÅØÊï∞Â≠ó„ÅÆ6Ê°Å„ÅÆ„Åø„Åß' },
      { type: 'image_url', image_url: { url: `data:${media};base64,${base64}` } }
    ]
  }], 50);
  return result.trim() || null;
};

// ÁîªÂÉèÂàÜÈ°ûÔºàGPT-4o-miniÂõ∫ÂÆö„Åß„Ç≥„Çπ„ÉàÂâäÊ∏õÔºâ
const classifyImages = async (key, images) => {
  const imageContents = images.map((img, i) => ({
    type: 'image_url',
    image_url: { url: img.dataUrl, detail: 'low' }
  }));
  
  const prompt = `„Åì„Çå„Çâ„ÅÆ‰∏≠Âè§PCÂïÜÂìÅÁîªÂÉè„ÇíÂàÜÈ°û„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÂêÑÁîªÂÉè„Å´„Å§„ÅÑ„Å¶‰ª•‰∏ã„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Åã„Çâ1„Å§ÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºö
- main: PCÂÖ®‰Ωì„ÅåË¶ã„Åà„ÇãÂÜôÁúüÔºà„É°„Ç§„É≥ÁîªÂÉèÔºâ
- screen: ÁîªÈù¢„Éª„Éá„Ç£„Çπ„Éó„É¨„Ç§Ôºà„Çπ„Éö„ÉÉ„ÇØË°®Á§∫Âê´„ÇÄÔºâ
- keyboard: „Ç≠„Éº„Éú„Éº„Éâ
- side: ÂÅ¥Èù¢„Éª„Éù„Éº„ÉàÈ°û
- spec: „Çπ„Éö„ÉÉ„ÇØË©≥Á¥∞„Éª„Ç∑„Éº„É´
- barcode: „Éê„Éº„Ç≥„Éº„Éâ„É©„Éô„É´
- other: „Åù„ÅÆ‰ªñ

JSONÂΩ¢Âºè„ÅßÂá∫ÂäõÔºàindex„ÅØ0„Åã„ÇâÔºâ:
{"results":[{"index":0,"category":"main"},{"index":1,"category":"screen"},...]}`;

  const r = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [{ role: 'user', content: [{ type: 'text', text: prompt }, ...imageContents] }],
      max_tokens: 500
    })
  });
  const d = await r.json();
  if (d.error) throw new Error(d.error.message);
  
  try {
    const text = d.choices[0].message.content.trim();
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]).results;
    }
  } catch (e) {
    console.error('ÂàÜÈ°ûÁµêÊûú„ÅÆ„Éë„Éº„Çπ„Ç®„É©„Éº:', e);
  }
  return null;
};

const generateIntro = async (key, p) => {
  const s = p.specs || {};
  // ÂûãÁï™„Åã„Çâ„Äå‰ªñ XÂè∞„Çª„ÉÉ„Éà„Äç„ÇíÂâäÈô§
  const modelClean = (s.product_name || '').replace(/‰ªñ?\s*\d+Âè∞[ÔΩæ„Çª][ÔΩØ„ÉÉ][ÔæÑ„Éà]/g, '').trim();
  const officeInfo = p.hasOffice ? 'Microsoft Office2024(Ê∞∏Á∂öÁâà)Êê≠Ëºâ' : '„Å™„Åó';
  
  // „Ç∏„É£„É≥„ÇØÂìÅ„ÅÆÂ†¥Âêà„ÅØÂ∞ÇÁî®„Éó„É≠„É≥„Éó„Éà
  if (p.isJunk) {
    const prompt = `‰ª•‰∏ã„ÅÆ„Ç∏„É£„É≥„ÇØÂìÅPC„ÅÆÁ¥π‰ªãÊñá„Çí3„Äú4Ë°å„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇËá™ÁÑ∂„Å™Êó•Êú¨Ë™û„Åß„ÄÇ„Ç∏„É£„É≥„ÇØÂìÅ„Åß„ÅÇ„Çã„Åì„Å®„ÄÅÂãï‰Ωú‰øùË®º„Åå„Å™„ÅÑ„Åì„Å®„ÄÅ‰øÆÁêÜ„ÉªÈÉ®ÂìÅÂèñ„ÇäÁî®„Åß„ÅÇ„Çã„Åì„Å®„ÇíÊòéÁ¢∫„Å´‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÂïÜÂìÅ„Çø„Ç§„Éó: ${p.product_type}
„É°„Éº„Ç´„Éº: ${s.maker}
ÂûãÁï™: ${modelClean}
CPU: ${s.cpu}
„É°„É¢„É™: ${s.memory}
„Çπ„Éà„É¨„Éº„Ç∏: ${s.storage}
Á¥π‰ªãÊñá„ÅÆ„Åø„ÇíÂá∫Âäõ:`;
    return await callOpenAI(key, [{ role: 'user', content: prompt }], 200);
  }
  
  const prompt = `‰ª•‰∏ã„ÅÆ‰∏≠Âè§PC„ÅÆÁ¥π‰ªãÊñá„Çí3„Äú4Ë°å„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇËá™ÁÑ∂„Å™Êó•Êú¨Ë™û„Åß„ÄÇ1Âè∞„ÅÆÂïÜÂìÅ„Å®„Åó„Å¶Á¥π‰ªã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÂïÜÂìÅ„Çø„Ç§„Éó: ${p.product_type}
„É°„Éº„Ç´„Éº: ${s.maker}
ÂûãÁï™: ${modelClean}
CPU: ${s.cpu}
„É°„É¢„É™: ${s.memory}
„Çπ„Éà„É¨„Éº„Ç∏: ${s.storage}
Office: ${officeInfo}
Á¥π‰ªãÊñá„ÅÆ„Åø„ÇíÂá∫Âäõ:`;
  return await callOpenAI(key, [{ role: 'user', content: prompt }], 200);
};

// ÁîªÂÉèÁµêÂêàÈñ¢Êï∞Ôºà2ÊûöÊ®™‰∏¶„Å≥ or 4Êûö„Ç∞„É™„ÉÉ„ÉâÔºâ+ Ëá™Âãï„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
const mergeImages = async (images, cols = 2, folder = '') => {
  const size = 1000; // 1Êûö„ÅÇ„Åü„Çä„ÅÆ„Çµ„Ç§„Ç∫
  const rows = Math.ceil(images.length / cols);
  const canvas = document.createElement('canvas');
  canvas.width = size * cols;
  canvas.height = size * rows;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  for (let i = 0; i < images.length; i++) {
    const img = new Image();
    await new Promise((resolve) => {
      img.onload = resolve;
      img.src = images[i].dataUrl;
    });
    const col = i % cols;
    const row = Math.floor(i / cols);
    ctx.drawImage(img, col * size, row * size, size, size);
  }
  
  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  
  // Ëá™Âãï„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
  const timestamp = Date.now();
  const filename = `_merged_${timestamp}.jpg`;
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  a.click();
  
  return { dataUrl, filename };
};

// „Ç¢„Ç§„Ç≥„É≥
const Icon = ({ name, className = "w-5 h-5" }) => {
  const icons = {
    upload: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />,
    file: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />,
    key: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />,
    image: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />,
    check: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />,
    x: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />,
    refresh: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />,
    left: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />,
    right: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />,
    scan: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />,
    eye: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />,
    eyeOff: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />,
    search: <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
  };
  return <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">{icons[name]}</svg>;
};

// DropZone„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const DropZone = ({ title, icon, color, accept, multiple, directory, onFiles, hint }) => {
  const [isDragging, setIsDragging] = useState(false);
  const inputRef = useRef(null);
  const fileInputRef = useRef(null);
  const dragCounter = useRef(0);
  
  const handleDragIn = (e) => {
    e.preventDefault();
    e.stopPropagation();
    dragCounter.current++;
    if (dragCounter.current === 1) {
      setIsDragging(true);
    }
  };
  
  const handleDragOut = (e) => {
    e.preventDefault();
    e.stopPropagation();
    dragCounter.current--;
    if (dragCounter.current === 0) {
      setIsDragging(false);
    }
  };
  
  const handleDragOver = (e) => {
    e.preventDefault();
    e.stopPropagation();
  };
  
  const handleDrop = async (e) => {
    e.preventDefault();
    e.stopPropagation();
    dragCounter.current = 0;
    setIsDragging(false);
    
    const items = e.dataTransfer.items;
    const droppedFiles = e.dataTransfer.files;
    const files = [];
    
    console.log('Drop event - items:', items?.length, 'files:', droppedFiles?.length);
    
    // webkitGetAsEntry„Åå‰Ωø„Åà„ÇãÂ†¥ÂêàÔºà„Éï„Ç©„É´„ÉÄÂØæÂøúÔºâ
    let entryError = false;
    if (items && items.length > 0) {
      const entries = [];
      for (let i = 0; i < items.length; i++) {
        if (items[i].webkitGetAsEntry) {
          const entry = items[i].webkitGetAsEntry();
          if (entry) entries.push(entry);
        }
      }
      
      if (entries.length > 0) {
        for (const entry of entries) {
          try {
            const entryFiles = await readEntry(entry);
            if (entryFiles.length > 0) {
              files.push(...entryFiles);
            } else if (entry.isDirectory) {
              // „Éï„Ç©„É´„ÉÄ„Å™„ÅÆ„Å´„Éï„Ç°„Ç§„É´„ÅåÂèñÂæó„Åß„Åç„Å™„Åã„Å£„Åü
              entryError = true;
            }
          } catch (err) {
            console.error('readEntry error:', err);
            entryError = true;
          }
        }
      }
    }
    
    // fallback: ÈÄöÂ∏∏„ÅÆ„Éï„Ç°„Ç§„É´
    if (files.length === 0 && droppedFiles.length > 0) {
      console.log('Using fallback file handling');
      for (let i = 0; i < droppedFiles.length; i++) {
        const f = droppedFiles[i];
        // „Éï„Ç©„É´„ÉÄ„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàsize=0, type=Á©∫Ôºâ
        if (f.size === 0 && f.type === '') {
          console.log('Detected folder in fallback, skipping:', f.name);
          entryError = true;
          continue;
        }
        // webkitRelativePath„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂêçÂâç„Çí„Çª„ÉÉ„Éà
        if (!f.webkitRelativePath) {
          Object.defineProperty(f, 'webkitRelativePath', {
            value: f.name,
            writable: false,
            configurable: true
          });
        }
        files.push(f);
      }
    }
    
    console.log('Processed files:', files.length, files.slice(0,5).map(f => f.webkitRelativePath || f.name));
    
    if (files.length > 0) {
      onFiles(files);
    } else if (entryError) {
      // „Éï„Ç©„É´„ÉÄ„Éâ„É≠„ÉÉ„Éó„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà
      alert('‚ö†Ô∏è „Éï„Ç©„É´„ÉÄ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\nÊó•Êú¨Ë™û„Éï„Ç©„É´„ÉÄÂêç„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÂØæÂøú„Åß„Åç„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\n„ÄêÂØæÂá¶Ê≥ï„Äë\n„Éª‰∏ã„ÅÆ„Äå„Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû„Äç„Éú„Çø„É≥„Çí‰Ωø„ÅÜ\n„Éª„Åæ„Åü„ÅØÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÁõ¥Êé•„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó');
    } else {
      console.warn('No files found after processing drop');
    }
  };
  
  const readEntry = async (entry, path = '') => {
    return new Promise(async (resolve) => {
      const files = [];
      
      // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆöÔºà10ÁßíÔºâ
      const timeout = setTimeout(() => {
        console.warn('readEntry timeout for:', path + entry.name);
        resolve(files);
      }, 10000);
      
      try {
        if (entry.isFile) {
          entry.file((file) => {
            clearTimeout(timeout);
            // webkitRelativePath„ÇíÊ®°ÂÄ£
            Object.defineProperty(file, 'webkitRelativePath', {
              value: path + file.name,
              writable: false,
              configurable: true
            });
            files.push(file);
            resolve(files);
          }, (err) => {
            clearTimeout(timeout);
            console.error('file() error:', err);
            resolve(files);
          });
        } else if (entry.isDirectory) {
          const reader = entry.createReader();
          const readAllEntries = async () => {
            return new Promise((res, rej) => {
              const results = [];
              const readBatch = () => {
                reader.readEntries((batch) => {
                  if (batch.length === 0) {
                    res(results);
                  } else {
                    results.push(...batch);
                    readBatch();
                  }
                }, (err) => {
                  console.error('readEntries error:', err);
                  // „Ç®„É©„Éº„Åß„ÇÇ‰ªä„Åæ„ÅßÂèñÂæó„Åó„ÅüÂàÜ„ÅØËøî„Åô
                  rej(err);
                });
              };
              readBatch();
            });
          };
          
          try {
            const entries = await readAllEntries();
            for (const child of entries) {
              const childFiles = await readEntry(child, path + entry.name + '/');
              files.push(...childFiles);
            }
          } catch (err) {
            // readAllEntries„Åß„Ç®„É©„Éº„ÅåÂá∫„ÅüÂ†¥ÂêàÔºàÊó•Êú¨Ë™û„Éï„Ç©„É´„ÉÄÂêç„Å™„Å©Ôºâ
            console.error('Failed to read directory:', entry.name, err);
          }
          clearTimeout(timeout);
          resolve(files);
        } else {
          clearTimeout(timeout);
          resolve(files);
        }
      } catch (err) {
        clearTimeout(timeout);
        console.error('readEntry catch error:', err);
        resolve(files);
      }
    });
  };
  
  const handleClick = () => {
    if (directory) {
      inputRef.current?.click();
    } else {
      inputRef.current?.click();
    }
  };
  
  const handleFileClick = (e) => {
    e.stopPropagation();
    fileInputRef.current?.click();
  };
  
  const handleChange = (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length > 0) {
      onFiles(files);
    }
  };
  
  const colorClasses = {
    blue: { border: 'hover:border-blue-400', icon: 'text-blue-500', dragBg: 'bg-blue-50 border-blue-400' },
    green: { border: 'hover:border-green-400', icon: 'text-green-500', dragBg: 'bg-green-50 border-green-400' },
    red: { border: 'hover:border-red-400', icon: 'text-red-500', dragBg: 'bg-red-50 border-red-400' },
    orange: { border: 'hover:border-orange-400', icon: 'text-orange-500', dragBg: 'bg-orange-50 border-orange-400' },
  };
  const c = colorClasses[color] || colorClasses.blue;
  
  return (
    <div 
      className="bg-white rounded shadow p-4"
      onDragEnter={handleDragIn}
      onDragLeave={handleDragOut}
      onDragOver={handleDragOver}
      onDrop={handleDrop}
    >
      <h3 className="font-bold mb-3 flex items-center gap-2">
        <Icon name={icon} className={`w-5 h-5 ${c.icon}`}/>{title}
      </h3>
      <div
        onClick={handleClick}
        className={`border-2 border-dashed rounded p-4 text-center cursor-pointer transition-all ${isDragging ? c.dragBg : `border-gray-300 ${c.border}`}`}
      >
        <Icon name="upload" className="w-6 h-6 mx-auto mb-1 text-gray-400"/>
        <span className="text-sm text-gray-600">{isDragging ? '„Éâ„É≠„ÉÉ„ÉóÔºÅ' : (hint || '„ÇØ„É™„ÉÉ„ÇØ or „Éâ„É©„ÉÉ„Ç∞')}</span>
        {directory && (
          <input
            ref={inputRef}
            type="file"
            accept={accept}
            multiple={multiple}
            webkitdirectory=""
            directory=""
            className="hidden"
            onChange={handleChange}
          />
        )}
        {!directory && (
          <input
            ref={inputRef}
            type="file"
            accept={accept}
            multiple={multiple}
            className="hidden"
            onChange={handleChange}
          />
        )}
      </div>
      {directory && (
        <div className="mt-2 flex gap-2">
          <button
            onClick={handleClick}
            className="flex-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-2 rounded border"
          >
            üìÅ „Éï„Ç©„É´„ÉÄ„ÇíÈÅ∏Êäû
          </button>
          <button
            onClick={handleFileClick}
            className="flex-1 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-2 rounded border"
          >
            üìÑ „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
          </button>
        </div>
      )}
      {directory && (
        <input
          ref={fileInputRef}
          type="file"
          accept={accept}
          multiple={true}
          className="hidden"
          onChange={handleChange}
        />
      )}
    </div>
  );
};

// „É°„Ç§„É≥App
function App() {
  const [step, setStep] = useState(1);
  const [apiKey, setApiKey] = useState(localStorage.getItem('openai_key') || '');
  const [aiModel, setAiModel] = useState(localStorage.getItem('openai_model') || 'gpt-4o');
  const [purchaseData, setPurchaseData] = useState([]);
  const [priceData, setPriceData] = useState([]);

  const [products, setProducts] = useState([]);
  const [currentIdx, setCurrentIdx] = useState(0);
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [dragIdx, setDragIdx] = useState(null);
  const [selectedImages, setSelectedImages] = useState([]);
  const [imageHistory, setImageHistory] = useState([]); // Â±•Ê≠¥ÔºàUndoÁî®Ôºâ
  const [zoomImage, setZoomImage] = useState(null); // Êã°Â§ßË°®Á§∫Áî®
  // ‰øùË®ºÊñá„ÉÜ„É≥„Éó„É¨„Éº„ÉàÔºàÁ∑®ÈõÜÂèØËÉΩÔºâ
  const [noticeText, setNoticeText] = useState(() => localStorage.getItem('mercari_notice_text') || DEFAULT_NOTICE_TEXT);
  const [showNoticeEditor, setShowNoticeEditor] = useState(false);

  // Ê§úÁ¥¢URLÊßãÁØâ
  const buildSearchQuery = (p) => {
    const s = p.specs || {};
    const parts = [s.maker, s.cpu, s.memory, s.storage].filter(Boolean);
    if (s.model) parts.unshift(s.model);
    return parts.join(' ').trim();
  };
  const buildYahooUrl = (query) => {
    const q = encodeURIComponent(query);
    return `https://auctions.yahoo.co.jp/closedsearch/closedsearch?p=${q}&va=${q}&b=1&n=50`;
  };
  const buildMercariUrl = (query) => {
    const q = encodeURIComponent(query);
    return `https://jp.mercari.com/search?keyword=${q}&status=sold_out&sort=created_time&order=desc`;
  };

  // ÂÜôÁúüÊåØ„ÇäÂàÜ„Åë„É¢„Éº„Éâ
  const [sorterMode, setSorterMode] = useState(false);
  const [sorterPhotos, setSorterPhotos] = useState([]);
  const [sorterSplits, setSorterSplits] = useState(new Set());
  const [sorterSelected, setSorterSelected] = useState(-1);
  const [sorterPreview, setSorterPreview] = useState(null);

  // ÂàùÊúü„É≠„Éº„ÉâÊôÇ„Å´localStorage„Åã„ÇâÂæ©ÂÖÉ
  useEffect(() => {
    try {
      const savedPurchase = localStorage.getItem('mercari_purchase_data');
      const savedPrice = localStorage.getItem('mercari_price_data');
      if (savedPurchase) {
        const data = JSON.parse(savedPurchase);
        setPurchaseData(data);
        console.log(`‰ªïÂÖ•„Éá„Éº„ÇøÂæ©ÂÖÉ: ${data.length}‰ª∂`);
      }
      if (savedPrice) {
        const data = JSON.parse(savedPrice);
        setPriceData(data);
        console.log(`‰æ°Ê†º„Éá„Éº„ÇøÂæ©ÂÖÉ: ${data.length}‰ª∂`);
      }
    } catch (e) {
      console.error('„Éá„Éº„ÇøÂæ©ÂÖÉ„Ç®„É©„Éº:', e);
    }
  }, []);

  // ‰ªïÂÖ•„Éá„Éº„ÇøÂ§âÊõ¥ÊôÇ„Å´‰øùÂ≠ò
  useEffect(() => {
    if (purchaseData.length > 0) {
      try {
        localStorage.setItem('mercari_purchase_data', JSON.stringify(purchaseData));
        console.log(`‰ªïÂÖ•„Éá„Éº„Çø‰øùÂ≠ò: ${purchaseData.length}‰ª∂`);
      } catch (e) {
        console.error('‰ªïÂÖ•„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', e);
      }
    }
  }, [purchaseData]);

  // ‰æ°Ê†º„Éá„Éº„ÇøÂ§âÊõ¥ÊôÇ„Å´‰øùÂ≠ò
  useEffect(() => {
    if (priceData.length > 0) {
      try {
        localStorage.setItem('mercari_price_data', JSON.stringify(priceData));
        console.log(`‰æ°Ê†º„Éá„Éº„Çø‰øùÂ≠ò: ${priceData.length}‰ª∂`);
      } catch (e) {
        console.error('‰æ°Ê†º„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', e);
      }
    }
  }, [priceData]);

  // „Éá„Éº„Çø„ÇØ„É™„Ç¢Èñ¢Êï∞
  const clearSavedData = () => {
    if (confirm('‰øùÂ≠ò„Åï„Çå„ÅüCSV„Éª‰æ°Ê†º„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
      localStorage.removeItem('mercari_purchase_data');
      localStorage.removeItem('mercari_price_data');
      setPurchaseData([]);
      setPriceData([]);
      setMessage('‰øùÂ≠ò„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
    }
  };

  // API„Ç≠„Éº‰øùÂ≠ò
  const saveApiKey = () => {
    localStorage.setItem('openai_key', apiKey);
    localStorage.setItem('openai_model', aiModel);
    setMessage('API„Ç≠„Éº„Éª„É¢„Éá„É´‰øùÂ≠òÂÆå‰∫Ü');
  };

  // API„ÉÜ„Çπ„Éà
  const testApi = async () => {
    if (!apiKey) return setMessage('‚ùå API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    setLoading(true);
    setMessage('„ÉÜ„Çπ„Éà‰∏≠...');
    try {
      const useNewParam = aiModel.includes('4.1') || aiModel.startsWith('gpt-5') || aiModel.startsWith('o1') || aiModel.startsWith('o3');
      const body = {
        model: aiModel,
        messages: [{ role: 'user', content: 'Say OK' }],
        ...(useNewParam ? { max_completion_tokens: 50 } : { max_tokens: 50 })
      };
      const r = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify(body)
      });
      const d = await r.json();
      if (d.error) {
        setMessage(`‚ùå ${aiModel}: ${d.error.message}`);
      } else {
        setMessage(`‚úÖ ${aiModel}: Êé•Á∂öOKÔºÅ`);
      }
    } catch (e) {
      setMessage(`‚ùå „Ç®„É©„Éº: ${e.message}`);
    }
    setLoading(false);
  };

  // ‰ªïÂÖ•CSVË™≠ËæºÔºà„Éï„Ç°„Ç§„É´ÈÖçÂàó„ÇíÂèó„ÅëÂèñ„ÇãÔºâ
  const handlePurchaseFiles = (files) => {
    const all = [];
    let done = 0;
    files.forEach(f => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        Papa.parse(ev.target.result, {
          header: true, skipEmptyLines: true,
          complete: (r) => {
            all.push(...r.data);
            if (++done === files.length) {
              setPurchaseData(all);
              setMessage(`‰ªïÂÖ•CSV: ${all.length}‰ª∂`);
            }
          }
        });
      };
      reader.readAsText(f, 'Shift_JIS');
    });
  };

  // ‰æ°Ê†ºExcelË™≠ËæºÔºà„Éï„Ç°„Ç§„É´ÈÖçÂàó„ÇíÂèó„ÅëÂèñ„ÇãÔºâ
  const handlePriceFiles = (files) => {
    const all = [];
    let done = 0;
    files.forEach(f => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        all.push(...json);
        if (++done === files.length) {
          setPriceData(all);
          setMessage(`‰æ°Ê†º: ${all.length}‰ª∂`);
        }
      };
      reader.readAsArrayBuffer(f);
    });
  };

  // Ëá™Âãï‰æ°Ê†ºË®àÁÆó: ‰ªïÂÖ•Âéü‰æ° ‚Üí Ë≤©Â£≤‰æ°Ê†º
  // Âºè: Ë≤©Â£≤‰æ°Ê†º = ROUND((‰ªïÂÖ•Âéü‰æ° + ÈÄÅÊñô1500 + Ê¢±ÂåÖÊùê1000) / (1 - ÊâãÊï∞Êñô0.1 - Âà©ÁõäÁéá0.2), 0)
  //    = ROUND((‰ªïÂÖ•Âéü‰æ° + 2500) / 0.7, 0)
  const calcSellingPrice = (purchaseCost) => {
    if (!purchaseCost || isNaN(purchaseCost) || purchaseCost <= 0) return null;
    return Math.round((purchaseCost + 2500) / 0.7);
  };

  // ÁîªÂÉèË™≠ËæºÔºà„Éï„Ç°„Ç§„É´ÈÖçÂàó„ÇíÂèó„ÅëÂèñ„Çã - „Éï„Ç©„É´„ÉÄ„Åß„ÇÇ„Éï„Ç°„Ç§„É´Áõ¥Êé•„Åß„ÇÇOKÔºâ
  const handleImageFiles = async (files) => {
    console.log('handleImageFiles called with', files.length, 'files');
    setLoading(true);
    setMessage('ÁîªÂÉèË™≠Ëæº‰∏≠...');
    const map = {};
    
    for (const f of files) {
      const path = f.webkitRelativePath || f.name;
      console.log('Processing file:', path, 'type:', f.type, 'size:', f.size);
      
      const parts = path.split('/');
      let folder, name;
      
      if (parts.length >= 2) {
        // „Éï„Ç©„É´„ÉÄÊßãÈÄ†„Åå„ÅÇ„ÇãÂ†¥Âêà
        folder = parts[parts.length - 2];
        name = parts[parts.length - 1];
      } else {
        // „Éï„Ç°„Ç§„É´Áõ¥Êé•„ÅÆÂ†¥ÂêàÔºö„Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÊã°ÂºµÂ≠ê„ÇíÈô§„ÅÑ„ÅüÈÉ®ÂàÜ„Çí„Éï„Ç©„É´„ÉÄÂêç„Å´
        // „Åæ„Åü„ÅØÊï∞Â≠óÈÉ®ÂàÜ„Åß„Ç∞„É´„Éº„Éî„É≥„Ç∞
        name = f.name;
        // „Éï„Ç°„Ç§„É´Âêç„ÅÆ„Éë„Çø„Éº„É≥„ÇíËß£ÊûêÔºà‰æã: 001_01.jpg ‚Üí 001„Åå„Éï„Ç©„É´„ÉÄÔºâ
        const match = name.match(/^(\d+)[_-]/);
        if (match) {
          folder = match[1];
        } else {
          // „Éë„Çø„Éº„É≥„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊã°ÂºµÂ≠ê„ÇíÈô§„ÅÑ„Åü„Éï„Ç°„Ç§„É´Âêç
          folder = name.replace(/\.[^.]+$/, '');
        }
      }
      
      const ext = name.split('.').pop().toLowerCase();
      if (!['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
        console.log('Skipping non-image file:', name);
        continue;
      }
      
      if (!map[folder]) map[folder] = [];
      
      try {
        const dataUrl = await new Promise((resolve, reject) => {
          const rd = new FileReader();
          rd.onload = e => resolve(e.target.result);
          rd.onerror = e => reject(e);
          rd.readAsDataURL(f);
        });
        map[folder].push({ id: `${folder}_${name}`, filename: name, dataUrl, excluded: false });
      } catch (err) {
        console.error('FileReader error for', name, err);
      }
    }
    
    console.log('Grouped into folders:', Object.keys(map));
    
    const prods = Object.entries(map).sort().map(([folder, imgs]) => ({
      id: folder, folder, images: imgs.sort((a, b) => a.filename.localeCompare(b.filename)), barcode: null
    }));
    
    if (prods.length === 0) {
      setMessage('ÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
      setLoading(false);
      return;
    }
    
    setProducts(prods);
    setMessage(`${prods.length}ÂïÜÂìÅ`);
    setStep(2);
    setLoading(false);
  };

  // === ÂÜôÁúüÊåØ„ÇäÂàÜ„Åë„É¢„Éº„Éâ ===
  const handleSorterFiles = async (files) => {
    setLoading(true);
    setMessage('ÂÜôÁúüË™≠Ëæº‰∏≠...');
    const photos = [];
    for (const f of files) {
      const name = f.name;
      const ext = name.split('.').pop().toLowerCase();
      if (!['jpg','jpeg','png','gif','webp'].includes(ext)) continue;
      try {
        const dataUrl = await new Promise((res, rej) => {
          const rd = new FileReader();
          rd.onload = e => res(e.target.result);
          rd.onerror = rej;
          rd.readAsDataURL(f);
        });
        photos.push({ id: name, filename: name, dataUrl, file: f });
      } catch(e) { console.error(e); }
    }
    photos.sort((a,b) => a.filename.localeCompare(b.filename));
    if (photos.length === 0) { setMessage('ÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); setLoading(false); return; }
    setSorterPhotos(photos);
    setSorterSplits(new Set());
    setSorterSelected(-1);
    setSorterMode(true);
    setLoading(false);
    setMessage('');
  };

  const sorterToggleSplit = () => {
    if (sorterSelected < 0 || sorterSelected >= sorterPhotos.length - 1) return;
    const sp = sorterSelected + 1;
    setSorterSplits(prev => {
      const n = new Set(prev);
      n.has(sp) ? n.delete(sp) : n.add(sp);
      return n;
    });
  };

  const sorterUndoSplit = () => {
    setSorterSplits(prev => {
      if (prev.size === 0) return prev;
      const sorted = Array.from(prev).sort((a,b) => b - a);
      const n = new Set(prev);
      n.delete(sorted[0]);
      return n;
    });
  };

  const sorterGetGroups = () => {
    const sorted = [0, ...Array.from(sorterSplits).sort((a,b) => a - b)];
    return sorted.map((start, i) => {
      const end = i + 1 < sorted.length ? sorted[i + 1] : sorterPhotos.length;
      return { start, end, count: end - start, photos: sorterPhotos.slice(start, end) };
    });
  };

  const sorterFinish = () => {
    const groups = sorterGetGroups();
    const prods = groups.map((g, i) => {
      const folder = `PC_${String(i+1).padStart(3,'0')}`;
      return {
        id: folder, folder,
        images: g.photos.map(p => ({ id: p.id, filename: p.filename, dataUrl: p.dataUrl, excluded: false })),
        barcode: null
      };
    });
    setProducts(prods);
    setSorterMode(false);
    setMessage(`${prods.length}ÂïÜÂìÅ„Å´ÊåØ„ÇäÂàÜ„Åë„Åæ„Åó„Åü`);
    setStep(2);
  };

  // OCR
  const doOcr = async (idx) => {
    const p = products[idx];
    if (!p.images.length || !apiKey) return;
    setLoading(true);
    try {
      const bc = await ocrBarcode(apiKey, p.images[p.images.length - 1].dataUrl);
      if (bc) {
        const np = [...products];
        np[idx].barcode = bc;
        setProducts(np);
        setMessage(`OCRÊàêÂäü: ${bc}`);
      } else {
        alert('Ë™≠ÂèñÂ§±Êïó: „Éê„Éº„Ç≥„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
      }
    } catch (e) {
      console.error('OCR Error:', e);
      alert('Ë™≠ÂèñÂ§±Êïó: ' + e.message);
    }
    setLoading(false);
  };

  const doOcrAll = async () => {
    if (!apiKey) return alert('API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    setLoading(true);
    let successCount = 0;
    for (let i = 0; i < products.length; i++) {
      if (products[i].barcode) continue;
      try {
        const bc = await ocrBarcode(apiKey, products[i].images[products[i].images.length - 1].dataUrl);
        if (bc) {
          const np = [...products];
          np[i].barcode = bc;
          setProducts(np);
          successCount++;
        }
      } catch (e) {
        console.error('OCR error for product', i, e);
      }
    }
    setMessage(`OCRÂÆå‰∫Ü: ${successCount}‰ª∂ÊàêÂäü`);
    setLoading(false);
  };

  // ÁîªÂÉè‰∏¶„Å≥Êõø„Åà
  const moveImage = (from, to) => {
    const p = products[currentIdx];
    const imgs = [...p.images];
    const [moved] = imgs.splice(from, 1);
    imgs.splice(to, 0, moved);
    const np = [...products];
    np[currentIdx] = { ...p, images: imgs };
    setProducts(np);
  };

  const toggleExclude = (imgIdx) => {
    const np = [...products];
    np[currentIdx].images[imgIdx].excluded = !np[currentIdx].images[imgIdx].excluded;
    setProducts(np);
  };

  // Ëá™ÂãïÁîªÂÉè‰∏¶„Å≥Êõø„Åà
  const autoSortImages = async () => {
    if (!apiKey) return setMessage('‚ùå API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    const cur = products[currentIdx];
    if (!cur) return;
    
    const activeImgs = cur.images.filter(img => !img.excluded);
    if (activeImgs.length < 2) return setMessage('‰∏¶„Å≥Êõø„Åà„ÇãÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
    
    setLoading(true);
    setMessage('üîÑ ÁîªÂÉè„ÇíÂàÜÈ°û‰∏≠...');
    
    try {
      const classifications = await classifyImages(apiKey, activeImgs);
      if (!classifications) {
        setMessage('‚ùå ÂàÜÈ°û„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        setLoading(false);
        return;
      }
      
      // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´ÂàÜÈ°û
      const byCategory = { main: [], screen: [], keyboard: [], side: [], spec: [], barcode: [], other: [] };
      classifications.forEach(c => {
        const img = activeImgs[c.index];
        if (img && byCategory[c.category]) {
          byCategory[c.category].push(img);
        } else if (img) {
          byCategory.other.push(img);
        }
      });
      
      // ‰∏¶„Å≥È†Ü: „É°„Ç§„É≥2 ‚Üí ÁîªÈù¢3 ‚Üí „Ç≠„Éº„Éú„Éº„Éâ2 ‚Üí ÂÅ¥Èù¢(ÁµêÂêà) ‚Üí „Çπ„Éö„ÉÉ„ÇØ(ÁµêÂêà) ‚Üí „Åù„ÅÆ‰ªñ ‚Üí „Éê„Éº„Ç≥„Éº„Éâ
      const sorted = [];
      const toMerge = [];
      
      // „É°„Ç§„É≥ÔºàÊúÄÂ§ß2ÊûöÔºâ
      sorted.push(...byCategory.main.slice(0, 2));
      if (byCategory.main.length > 2) byCategory.other.push(...byCategory.main.slice(2));
      
      // ÁîªÈù¢ÔºàÊúÄÂ§ß3Êûö„ÄÅÂ§ö„ÅÑÂ†¥Âêà„ÅØÁµêÂêàÂÄôË£úÔºâ
      if (byCategory.screen.length <= 3) {
        sorted.push(...byCategory.screen);
      } else {
        sorted.push(...byCategory.screen.slice(0, 2));
        toMerge.push({ name: 'screen', imgs: byCategory.screen.slice(2) });
      }
      
      // „Ç≠„Éº„Éú„Éº„ÉâÔºàÊúÄÂ§ß2ÊûöÔºâ
      sorted.push(...byCategory.keyboard.slice(0, 2));
      if (byCategory.keyboard.length > 2) byCategory.other.push(...byCategory.keyboard.slice(2));
      
      // ÂÅ¥Èù¢Ôºà4Êûö‰ª•‰∏ä„Å™„ÇâÁµêÂêàÔºâ
      if (byCategory.side.length >= 4) {
        toMerge.push({ name: 'side', imgs: byCategory.side.slice(0, 4) });
        if (byCategory.side.length > 4) byCategory.other.push(...byCategory.side.slice(4));
      } else {
        sorted.push(...byCategory.side);
      }
      
      // „Çπ„Éö„ÉÉ„ÇØÔºà2Êûö‰ª•‰∏ä„Å™„ÇâÁµêÂêàÔºâ
      if (byCategory.spec.length >= 2) {
        toMerge.push({ name: 'spec', imgs: byCategory.spec });
      } else {
        sorted.push(...byCategory.spec);
      }
      
      // „Åù„ÅÆ‰ªñ
      sorted.push(...byCategory.other);
      
      // ÁµêÂêàÂá¶ÁêÜ
      for (const item of toMerge) {
        if (item.imgs.length >= 2) {
          setMessage(`üîÑ ${item.name}ÁîªÂÉè„ÇíÁµêÂêà‰∏≠...`);
          const cols = item.imgs.length <= 2 ? 2 : 2;
          const { dataUrl, filename } = await mergeImages(item.imgs, cols);
          sorted.push({ id: `merged_${Date.now()}_${item.name}`, filename, dataUrl, excluded: false });
        }
      }
      
      // „Éê„Éº„Ç≥„Éº„ÉâÔºàÊúÄÂæåÔºâ
      sorted.push(...byCategory.barcode);
      
      // ÂÖÉ„ÅÆÁîªÂÉè„ÅßÁµêÂêà„Åï„Çå„Åü„ÇÇ„ÅÆ„ÇíexcludedÊâ±„ÅÑ„Å´
      const mergedIds = new Set(toMerge.flatMap(t => t.imgs.map(i => i.id)));
      const finalImages = cur.images.map(img => {
        if (mergedIds.has(img.id)) return { ...img, excluded: true };
        return img;
      });
      
      // ‰∏¶„Å≥Êõø„ÅàÁµêÊûú„ÇíÂèçÊò†Ôºàexcluded‰ª•Â§ñ„ÇíÁΩÆ„ÅçÊèõ„ÅàÔºâ
      const excludedImgs = finalImages.filter(img => img.excluded);
      const newImages = [...sorted, ...excludedImgs];
      
      const np = [...products];
      np[currentIdx].images = newImages;
      setProducts(np);
      setMessage(`‚úÖ ‰∏¶„Å≥Êõø„ÅàÂÆå‰∫ÜÔºÅÔºà${sorted.length}ÊûöÔºâ`);
    } catch (e) {
      setMessage(`‚ùå „Ç®„É©„Éº: ${e.message}`);
    }
    setLoading(false);
  };

  // „Éá„Éº„ÇøÂá¶ÁêÜ
  const processProducts = () => {
    setLoading(true);
    // ÂçòÂìÅ„Éá„Éº„Çø„ÇíÂÑ™ÂÖàÔºà„Äå‰ªñ„Äç„Åå„Å§„ÅÑ„Å¶„Å™„ÅÑ„ÇÇ„ÅÆÔºâ
    const findPurchase = (bc) => {
      const matches = purchaseData.filter(r => {
        const v = String(r['„Éê„Éº„Ç≥„Éº„ÉâÁï™Âè∑'] || '').replace(/[^0-9]/g, '');
        return v.length >= 6 && v.slice(-6) === bc;
      });
      if (matches.length === 0) return null;
      // „Äå‰ªñ„Äç„Åå„Å™„ÅÑ„ÇÇ„ÅÆÔºàÂçòÂìÅÔºâ„ÇíÂÑ™ÂÖà
      const single = matches.find(r => !String(r['„Éê„Éº„Ç≥„Éº„ÉâÁï™Âè∑'] || '').includes('‰ªñ'));
      return single || matches[0];
    };
    // „Éê„Éº„Ç≥„Éº„ÉâÁï™Âè∑„ÅÆ‰∏ã6Ê°Å„Åß‰æ°Ê†º„ÇíÁÖßÂêà
    const findPrice = (bc) => priceData.find(r => {
      const v = String(r['„Éê„Éº„Ç≥„Éº„ÉâÁï™Âè∑'] || '').replace(/[^0-9]/g, '');
      return v.length >= 6 && v.slice(-6) === bc;
    });

    const np = products.map(p => {
      if (!p.barcode) return { ...p, status: 'no_barcode' };
      const row = findPurchase(p.barcode);
      if (!row) return { ...p, status: 'no_data' };
      const specs = extractSpecs(row);
      const type = detectProductType(row, specs);
      const priceRow = findPrice(p.barcode);
      let price = priceRow ? parseInt(priceRow['„É°„É´„Ç´„É™Ë≤©Â£≤‰æ°Ê†º(ÂÖ•Âäõ)']) || null : null;
      // ‰æ°Ê†ºExcel„Å´ÁÑ°„Åë„Çå„Å∞‰ªïÂÖ•Âéü‰æ°„Åã„ÇâËá™ÂãïË®àÁÆó
      const purchaseCost = parseInt(row['ÊàêÁ¥ÑÈáëÈ°ç']) || parseInt(row['Ëá™Á§æÂÖ•Êú≠ÈáëÈ°ç']) || null;
      if (!price && purchaseCost) {
        price = calcSellingPrice(purchaseCost);
      }
      const rank = String(row['Ë©ï‰æ°ÁÇπ'] || '').trim().toUpperCase();
      const acc = parseAccessories(row['‰ªòÂ±ûÂìÅÊÉÖÂ†±'] || '');
      const defect = [row['ÁëïÁñµÊÉÖÂ†±1'], row['ÁëïÁñµÊÉÖÂ†±2']].filter(x => x && !x.includes('‰∏≠Âè§ÂìÅ„ÅÆÁÇ∫')).join('„ÄÅ');
      return {
        ...p, status: 'ok', specs, product_type: type, price, purchaseCost, rank,
        condition: CONDITION_MAP[rank] || '„ÇÑ„ÇÑÂÇ∑„ÇÑÊ±ö„Çå„ÅÇ„Çä',
        accessories: acc, defect_info: defect,
        is_english_kb: (row['‰ªòÂ±ûÂìÅÊÉÖÂ†±'] || '').includes('Ëã±Â≠óKB'),
        hasOffice: p.hasOffice || false,  // OFFICEÊê≠Ëºâ„Éï„É©„Ç∞„Çí‰øùÊåÅ
        isJunk: p.isJunk || false  // „Ç∏„É£„É≥„ÇØÂìÅ„Éï„É©„Ç∞„Çí‰øùÊåÅ
      };
    });
    setProducts(np);
    setStep(3);
    setLoading(false);
  };

  // „Éó„É¨„Éì„É•„ÉºÁîªÈù¢„Å∏ÔºàÁ¥π‰ªãÊñáÁîüÊàêÔºâ
  const goToPreview = async () => {
    setLoading(true);
    setMessage('Á¥π‰ªãÊñáÁîüÊàê‰∏≠...');
    const np = [...products];
    
    for (let i = 0; i < np.length; i++) {
      if (!np[i].barcode || np[i].intro) continue;
      try {
        np[i].intro = apiKey ? await generateIntro(apiKey, np[i]) : `${np[i].specs?.maker || ''}„ÅÆ‰∏≠Âè§PC„Åß„Åô„ÄÇ`;
        // „Çø„Ç§„Éà„É´„Å®Ë™¨ÊòéÊñá„ÇÇ‰∫ãÂâçÁîüÊàê
        np[i].title = np[i].title || makeTitle(np[i]);
        np[i].description = np[i].description || makeDescription(np[i], noticeText);
        setProducts([...np]);
        setMessage(`Á¥π‰ªãÊñáÁîüÊàê‰∏≠... (${i+1}/${np.length})`);
      } catch (e) {
        console.error('Á¥π‰ªãÊñáÁîüÊàê„Ç®„É©„Éº:', e);
        np[i].intro = `${np[i].specs?.maker || ''}„ÅÆ‰∏≠Âè§PC„Åß„Åô„ÄÇ`;
        np[i].title = np[i].title || makeTitle(np[i]);
        np[i].description = np[i].description || makeDescription(np[i], noticeText);
      }
    }
    
    // „Éê„Éº„Ç≥„Éº„Éâ„ÅÇ„ÇãÂïÜÂìÅ„ÅÆ„Çø„Ç§„Éà„É´„ÉªË™¨ÊòéÊñá„ÇíÁîüÊàê
    np.forEach(p => {
      if (p.barcode && !p.title) p.title = makeTitle(p);
      if (p.barcode && !p.description) p.description = makeDescription(p, noticeText);
    });
    
    setProducts(np);
    setCurrentIdx(0);
    setStep(4);
    setLoading(false);
    setMessage('');
  };

  // CSVÁîüÊàê
  const generateCsv = async () => {
    setLoading(true);
    setMessage('CSVÁîüÊàê‰∏≠...');
    
    // „É°„É´„Ç´„É™CSV„Éò„ÉÉ„ÉÄ„ÉºÔºàÊ≠£„Åó„ÅÑÈ†ÜÂ∫èÔºâ
    const headers = [
      ...Array.from({length:20}, (_,i) => `ÂïÜÂìÅÁîªÂÉèÂêç_${i+1}`),
      'ÂïÜÂìÅÂêç', 'ÂïÜÂìÅË™¨Êòé',
      'SKU1_Á®ÆÈ°û', 'SKU1_Âú®Â∫´Êï∞', 'SKU1_ÂïÜÂìÅÁÆ°ÁêÜ„Ç≥„Éº„Éâ', 'SKU1_JAN„Ç≥„Éº„Éâ',
      '„Éñ„É©„É≥„ÉâID', 'Ë≤©Â£≤‰æ°Ê†º', '„Ç´„ÉÜ„Ç¥„É™ID', 'ÂïÜÂìÅ„ÅÆÁä∂ÊÖã',
      'ÈÖçÈÄÅÊñπÊ≥ï', 'Áô∫ÈÄÅÂÖÉ„ÅÆÂú∞Âüü', 'Áô∫ÈÄÅ„Åæ„Åß„ÅÆÊó•Êï∞', 'ÂïÜÂìÅ„Çπ„ÉÜ„Éº„Çø„Çπ', 'ÈÖçÈÄÅÊñô„ÅÆË≤†ÊãÖ'
    ];
    
    // „Éï„Ç£„É´„Çø„ÉºÔºà„Éê„Éº„Ç≥„Éº„Éâ„Åå„ÅÇ„Çå„Å∞OK„ÄÅ‰æ°Ê†º„Å™„Åó„ÅØ999999Ôºâ
    const okProducts = products.filter(p => p.barcode);
    
    const rows = okProducts.map(p => {
      // ÁîªÂÉè„Éï„Ç°„Ç§„É´ÂêçÔºà„Éê„Éº„Ç≥„Éº„ÉâÁîªÂÉèÈô§„Åè„ÄÅÂÖÉ„ÅÆ„Éï„Ç°„Ç§„É´Âêç„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®„ÄÅÊúÄÂ§ß20ÊûöÔºâ
      const imgs = p.images
        .filter((img, i) => i < p.images.length - 1 && !img.excluded)
        .slice(0, 20)
        .map(img => img.filename);  // ÂÖÉ„ÅÆ„Éï„Ç°„Ç§„É´Âêç„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
      while (imgs.length < 20) imgs.push('');
      
      const cat = ['intel_mac', 'apple_silicon'].includes(p.product_type) ? CONFIG.category_macbook : CONFIG.category_windows;
      const conditionCode = CONFIG.condition_map[p.condition] || 4;
      const price = p.price || 999999;  // ‰æ°Ê†º„Åå„Å™„Åë„Çå„Å∞999999
      
      return [
        ...imgs,                           // ÂïÜÂìÅÁîªÂÉèÂêç_1ÔΩû20
        p.title || makeTitle(p),           // ÂïÜÂìÅÂêçÔºàÁ∑®ÈõÜÊ∏à„Åø„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®Ôºâ
        p.description || makeDescription(p, noticeText), // ÂïÜÂìÅË™¨ÊòéÔºàÁ∑®ÈõÜÊ∏à„Åø„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®Ôºâ
        '',                                // SKU1_Á®ÆÈ°û
        1,                                 // SKU1_Âú®Â∫´Êï∞
        '',                                // SKU1_ÂïÜÂìÅÁÆ°ÁêÜ„Ç≥„Éº„ÉâÔºàÁ©∫Ôºâ
        '',                                // SKU1_JAN„Ç≥„Éº„Éâ
        '',                                // „Éñ„É©„É≥„ÉâID
        price,                             // Ë≤©Â£≤‰æ°Ê†º
        cat,                               // „Ç´„ÉÜ„Ç¥„É™ID
        conditionCode,                     // ÂïÜÂìÅ„ÅÆÁä∂ÊÖã
        CONFIG.shipping_method,            // ÈÖçÈÄÅÊñπÊ≥ï
        CONFIG.region,                     // Áô∫ÈÄÅÂÖÉ„ÅÆÂú∞Âüü
        CONFIG.shipping_days,              // Áô∫ÈÄÅ„Åæ„Åß„ÅÆÊó•Êï∞
        1,                                 // ÂïÜÂìÅ„Çπ„ÉÜ„Éº„Çø„ÇπÔºà1=‰∏ãÊõ∏„ÅçÔºâ
        CONFIG.shipping_fee                // ÈÖçÈÄÅÊñô„ÅÆË≤†ÊãÖ
      ];
    });
    
    // CSVÁîüÊàêÔºàShift-JIS„ÄÅÊîπË°å„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºâ
    const escapeForCsv = (str) => {
      const s = String(str);
      // „ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà„Çí„Ç®„Çπ„Ç±„Éº„Éó
      if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    };
    
    const csvContent = [headers, ...rows].map(r => r.map(c => escapeForCsv(c)).join(',')).join('\r\n');
    
    // Shift-JIS„Å´Â§âÊèõ„Åó„Å¶Blob‰ΩúÊàê
    const unicodeArray = Encoding.stringToCode(csvContent);
    const sjisArray = Encoding.convert(unicodeArray, { to: 'SJIS', from: 'UNICODE' });
    const blob = new Blob([new Uint8Array(sjisArray)], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `mercari_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    setMessage(`${rows.length}ÂïÜÂìÅ„ÅÆCSV„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü`);
    setStep(5);
    setLoading(false);
  };

  const cur = products[currentIdx];

  return (
    <div className="min-h-screen bg-gray-100">
      <header className="bg-red-500 text-white py-3 px-6 shadow">
        <h1 className="text-xl font-bold">„É°„É´„Ç´„É™CSVÁîüÊàê„ÉÑ„Éº„É´</h1>
      </header>

      <div className="max-w-6xl mx-auto p-4">
        {/* „Çπ„ÉÜ„Éº„Çø„Çπ */}
        <div className="bg-white rounded shadow p-3 mb-4 flex gap-6 text-sm items-center">
          <span>‰ªïÂÖ•: <b>{purchaseData.length}</b></span>
          <span>‰æ°Ê†º: <b>{priceData.length}</b></span>
          <span>API: {apiKey ? '‚úì' : 'Êú™Ë®≠ÂÆö'}</span>
          <span className="text-purple-600">ü§ñ {aiModel}</span>
          {(purchaseData.length > 0 || priceData.length > 0) && (
            <button onClick={clearSavedData} className="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è „Éá„Éº„Çø„ÇØ„É™„Ç¢</button>
          )}
          <span className="ml-auto text-gray-500">Step {step}/5</span>
          <button onClick={() => setShowNoticeEditor(true)} className="text-gray-500 hover:text-gray-700 text-xs ml-2">üìù ‰øùË®ºÊñá</button>
          {sorterPhotos.length > 0 && !sorterMode && (
            <button onClick={() => setSorterMode(true)} className="text-blue-500 hover:text-blue-700 text-xs ml-2">üì∑ ÊåØ„ÇäÂàÜ„ÅëÂÜçÈñã</button>
          )}
        </div>

        {message && <div className={`px-4 py-2 rounded mb-4 border ${message.startsWith('‚ùå') ? 'bg-red-50 border-red-200 text-red-700' : message.startsWith('‚úÖ') ? 'bg-green-50 border-green-200 text-green-700' : 'bg-blue-50 border-blue-200 text-blue-700'}`}>{message}</div>}

        {/* Step 1 */}
        {step === 1 && (
          <div>
            {/* ‰øùÂ≠ò„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆË°®Á§∫ */}
            {(purchaseData.length > 0 || priceData.length > 0) && (
              <div className="bg-green-50 border border-green-200 rounded p-3 mb-4 text-sm">
                <span className="font-medium text-green-700">üíæ ‰øùÂ≠òÊ∏à„Åø„Éá„Éº„Çø: </span>
                {purchaseData.length > 0 && <span className="mr-3">‰ªïÂÖ•CSV {purchaseData.length}‰ª∂</span>}
                {priceData.length > 0 && <span className="mr-3">‰æ°Ê†º„Éá„Éº„Çø {priceData.length}‰ª∂</span>}
                <span className="text-green-600 ml-2">ÔºàËá™ÂãïÂæ©ÂÖÉÊ∏à„ÅøÔºâ</span>
              </div>
            )}
            <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
              <DropZone
                title="‰ªïÂÖ•CSV"
                icon="file"
                color="blue"
                accept=".csv"
                multiple={true}
                onFiles={handlePurchaseFiles}
              />
              <DropZone
                title="‰æ°Ê†ºExcel"
                icon="file"
                color="green"
                accept=".xlsx,.xls,.csv"
                multiple={true}
                onFiles={handlePriceFiles}
              />
              <div className="bg-white rounded shadow p-4">
                <h3 className="font-bold mb-3 flex items-center gap-2"><Icon name="key" className="w-5 h-5 text-purple-500"/>OpenAI API</h3>
                <input type="password" placeholder="sk-..." value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full border rounded px-2 py-1 mb-2 text-sm"/>
                <select value={aiModel} onChange={e => setAiModel(e.target.value)} className="w-full border rounded px-2 py-1 mb-2 text-sm">
                  <option value="gpt-4o">gpt-4o</option>
                  <option value="gpt-4o-mini">gpt-4o-mini</option>
                  <option value="gpt-4.1">gpt-4.1</option>
                  <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                  <option value="gpt-5.1">gpt-5.1</option>
                  <option value="o1">o1</option>
                  <option value="o3-mini">o3-mini</option>
                </select>
                <div className="flex gap-2">
                  <button onClick={saveApiKey} className="flex-1 bg-purple-500 text-white rounded py-1 text-sm hover:bg-purple-600">‰øùÂ≠ò</button>
                  <button onClick={testApi} disabled={loading} className="flex-1 bg-blue-500 text-white rounded py-1 text-sm hover:bg-blue-600 disabled:opacity-50">„ÉÜ„Çπ„Éà</button>
                </div>
              </div>
              <DropZone
                title="ÁîªÂÉè"
                icon="image"
                color="red"
                accept="image/*"
                multiple={true}
                directory={true}
                onFiles={handleImageFiles}
                hint="„Éâ„É©„ÉÉ„Ç∞ or ‰∏ã„ÅÆ„Éú„Çø„É≥"
              />
              <DropZone
                title="ÂÜôÁúüÊåØ„ÇäÂàÜ„Åë"
                icon="image"
                color="blue"
                accept="image/*"
                multiple={true}
                onFiles={handleSorterFiles}
                hint="Êú™Êï¥ÁêÜÂÜôÁúü„Çí„Éâ„É≠„ÉÉ„Éó"
              />
            </div>
            {/* ÂïÜÂìÅ„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅStep2„Å´Êàª„Çå„Çã„Éú„Çø„É≥ */}
            {products.length > 0 && (
              <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded flex items-center justify-between">
                <span className="text-yellow-800">üì¶ Á∑®ÈõÜ‰∏≠„ÅÆÂïÜÂìÅ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„ÅôÔºà{products.length}‰ª∂Ôºâ</span>
                <button onClick={() => setStep(2)} className="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                  Step2„Å´Êàª„Çã ‚Üí
                </button>
              </div>
            )}
          </div>
        )}

        {/* Step 2: ÁîªÂÉèÁ∑®ÈõÜ */}
        {step === 2 && cur && (() => {
          const activeImages = cur.images.filter(img => !img.excluded);
          const excludedImages = cur.images.filter(img => img.excluded);
          const uploadCount = activeImages.length > 0 ? activeImages.length - 1 : 0; // „Éê„Éº„Ç≥„Éº„Éâ‰ª•Â§ñ
          
          // Â±•Ê≠¥„Å´‰øùÂ≠ò„Åô„ÇãÈñ¢Êï∞
          const saveHistory = () => {
            setImageHistory(prev => [...prev, JSON.parse(JSON.stringify(cur.images))]);
          };
          
          // UndoÈñ¢Êï∞
          const undoMerge = () => {
            if (imageHistory.length === 0) return;
            const np = [...products];
            np[currentIdx].images = imageHistory[imageHistory.length - 1];
            setProducts(np);
            setImageHistory(prev => prev.slice(0, -1));
          };
          
          return (
          <div className="bg-white rounded shadow">
            <div className="border-b p-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button onClick={() => { setCurrentIdx(Math.max(0, currentIdx-1)); setImageHistory([]); }} disabled={currentIdx===0} className="p-1 rounded hover:bg-gray-100 disabled:opacity-30"><Icon name="left"/></button>
                <span className="font-bold">{currentIdx+1}/{products.length}</span>
                <button onClick={() => { setCurrentIdx(Math.min(products.length-1, currentIdx+1)); setImageHistory([]); }} disabled={currentIdx===products.length-1} className="p-1 rounded hover:bg-gray-100 disabled:opacity-30"><Icon name="right"/></button>
                <span className="text-gray-500">{cur.folder}</span>
                {cur.barcode && <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-sm">{cur.barcode}</span>}
                <label className="flex items-center gap-1 ml-4 cursor-pointer">
                  <input 
                    type="checkbox" 
                    checked={cur.hasOffice || false}
                    onChange={e => { const np = [...products]; np[currentIdx].hasOffice = e.target.checked; setProducts(np); }}
                    className="w-4 h-4"
                  />
                  <span className="text-sm font-medium text-blue-600">üì¶ OFFICEÊê≠Ëºâ</span>
                </label>
                <label className="flex items-center gap-1 ml-2 cursor-pointer">
                  <input 
                    type="checkbox" 
                    checked={cur.isJunk || false}
                    onChange={e => { const np = [...products]; np[currentIdx].isJunk = e.target.checked; setProducts(np); }}
                    className="w-4 h-4"
                  />
                  <span className="text-sm font-medium text-red-600">‚ö†Ô∏è „Ç∏„É£„É≥„ÇØÂìÅ</span>
                </label>
              </div>
              <div className="flex items-center gap-2">
                <span className={`text-sm font-bold ${uploadCount <= 10 ? 'text-green-600' : 'text-red-600'}`}>
                  Âá∫ÂìÅÁîªÂÉè: {uploadCount}Êûö {uploadCount > 10 && '‚ö†Ô∏è 10Êûö‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ'}
                </span>
                <button onClick={doOcrAll} disabled={loading} className="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600 disabled:opacity-50">
                  {loading ? 'Âá¶ÁêÜ‰∏≠...' : 'ÂÖ®OCR'}
                </button>
              </div>
            </div>

            <div className="flex">
              {/* ÂïÜÂìÅ„É™„Çπ„Éà */}
              <div className="w-44 border-r bg-gray-50 p-2 max-h-[600px] overflow-y-auto">
                {products.map((p, i) => {
                  const pActive = p.images.filter(img => !img.excluded);
                  const pUpload = pActive.length > 0 ? pActive.length - 1 : 0;
                  return (
                  <button key={p.id} onClick={() => { setCurrentIdx(i); setSelectedImages([]); setImageHistory([]); }} className={`w-full text-left px-2 py-1 rounded text-sm truncate ${i === currentIdx ? 'bg-blue-500 text-white' : 'hover:bg-gray-200'}`}>
                    {i+1}. {p.folder} {p.barcode && '‚úì'} <span className={pUpload > 10 ? 'text-red-400' : ''}>[{pUpload}]</span>
                  </button>
                  );
                })}
              </div>

              {/* „É°„Ç§„É≥Á∑®ÈõÜ„Ç®„É™„Ç¢ */}
              <div className="flex-1 p-4 overflow-y-auto max-h-[600px]">
                {/* Âá∫ÂìÅÁîªÂÉèÔºà„Éê„Éº„Ç≥„Éº„Éâ‰ª•Â§ñÔºâ */}
                <div className="mb-4">
                  <div className="flex items-center gap-2 mb-2 flex-wrap">
                    <h4 className="font-bold text-sm">üì∑ Âá∫ÂìÅÁîªÂÉèÔºàÊúÄÂæå„ÅÆ1Êûö=„Éê„Éº„Ç≥„Éº„ÉâÔºâ</h4>
                    <span className="text-xs text-gray-500">„ÇØ„É™„ÉÉ„ÇØ:ÈÅ∏Êäû / „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ:Êã°Â§ß</span>
                    {selectedImages.length >= 2 && (
                      <button onClick={async () => {
                        saveHistory();
                        const selected = selectedImages.map(idx => cur.images.find((img, i) => i === idx)).filter(Boolean);
                        if (selected.length < 2) return;
                        const cols = selected.length <= 2 ? 2 : 2;
                        const { dataUrl, filename } = await mergeImages(selected, cols);
                        const np = [...products];
                        const newImg = { id: `merged_${Date.now()}`, filename, dataUrl, excluded: false };
                        // ÂÖÉ„ÅÆ‰ΩçÁΩÆÔºàÊúÄÂàù„Å´ÈÅ∏Êäû„Åó„ÅüÁîªÂÉè„ÅÆ‰ΩçÁΩÆÔºâ„Å´ÊåøÂÖ•
                        const firstIdx = Math.min(...selectedImages);
                        const newImages = cur.images.map((img, i) => selectedImages.includes(i) ? {...img, excluded: true} : img);
                        newImages.splice(firstIdx, 0, newImg);
                        np[currentIdx].images = newImages;
                        setProducts(np);
                        setSelectedImages([]);
                      }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">
                        {selectedImages.length}Êûö„ÇíÁµêÂêà
                      </button>
                    )}
                    {selectedImages.length > 0 && (
                      <button onClick={() => setSelectedImages([])} className="px-2 py-1 bg-gray-300 text-gray-700 rounded text-xs">ÈÅ∏ÊäûËß£Èô§</button>
                    )}
                    {imageHistory.length > 0 && (
                      <button onClick={undoMerge} className="px-2 py-1 bg-yellow-500 text-white rounded text-xs">‚Ü© Êàª„Åô ({imageHistory.length})</button>
                    )}
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {cur.images.map((img, i) => {
                      if (img.excluded) return null;
                      const activeIdx = activeImages.indexOf(img);
                      const isBarcode = activeIdx === activeImages.length - 1;
                      const isSelected = selectedImages.includes(i);
                      const displayNum = activeIdx + 1;
                      return (
                      <div key={img.id} 
                        draggable={!isBarcode}
                        onDragStart={() => !isBarcode && setDragIdx(i)} 
                        onDragOver={e => e.preventDefault()} 
                        onDrop={() => { if (dragIdx !== null && dragIdx !== i) moveImage(dragIdx, i); setDragIdx(null); }}
                        onClick={() => {
                          if (isBarcode) {
                            setZoomImage(img.dataUrl);
                          } else if (isSelected) {
                            setSelectedImages(selectedImages.filter(x => x !== i));
                          } else {
                            setSelectedImages([...selectedImages, i]);
                          }
                        }}
                        onDoubleClick={() => !isBarcode && setZoomImage(img.dataUrl)}
                        className={`relative cursor-pointer ${isSelected ? 'ring-4 ring-blue-500' : ''} ${isBarcode ? 'ring-2 ring-red-400' : ''}`}>
                        <img src={img.dataUrl} className={`w-24 h-24 object-cover rounded border-2 ${isBarcode ? 'border-red-400' : 'border-gray-200'}`}/>
                        <span className={`absolute top-1 left-1 text-xs px-1 rounded ${isBarcode ? 'bg-red-500 text-white' : 'bg-black/50 text-white'}`}>{isBarcode ? 'üîçBC' : displayNum}</span>
                        {isSelected && <span className="absolute top-1 right-1 bg-blue-500 text-white text-xs px-1 rounded">‚úì</span>}
                        <button onClick={(e) => { e.stopPropagation(); toggleExclude(i); }} className="absolute bottom-1 right-1 bg-white rounded-full p-0.5 opacity-70 hover:opacity-100">
                          <Icon name="eyeOff" className="w-3 h-3"/>
                        </button>
                      </div>
                      );
                    })}
                  </div>
                </div>

                {/* Èô§Â§ñÁîªÂÉè */}
                {excludedImages.length > 0 && (
                <div className="mb-4">
                  <h4 className="font-bold text-sm mb-2 text-gray-400">üö´ Èô§Â§ñÊ∏à„ÅøÔºà{excludedImages.length}ÊûöÔºâ- „ÇØ„É™„ÉÉ„ÇØ„ÅßÂæ©ÂÖÉ</h4>
                  <div className="flex flex-wrap gap-2">
                    {cur.images.map((img, i) => {
                      if (!img.excluded) return null;
                      return (
                      <div key={img.id} className="relative opacity-50 cursor-pointer hover:opacity-80" onClick={() => toggleExclude(i)}>
                        <img src={img.dataUrl} className="w-20 h-20 object-cover rounded border-2 border-gray-300 grayscale"/>
                        <button onClick={(e) => { e.stopPropagation(); toggleExclude(i); }} className="absolute top-1 right-1 bg-white rounded-full p-0.5">
                          <Icon name="eye" className="w-3 h-3"/>
                        </button>
                      </div>
                      );
                    })}
                  </div>
                </div>
                )}
              </div>

              {/* Âè≥„Éë„Éç„É´ */}
              <div className="w-56 border-l p-4 bg-gray-50">
                <label className="block text-sm font-medium mb-1">„Éê„Éº„Ç≥„Éº„Éâ</label>
                <div className="flex gap-1 mb-3">
                  <input type="text" value={cur.barcode || ''} onChange={e => { const np = [...products]; np[currentIdx].barcode = e.target.value; setProducts(np); }} className="flex-1 border rounded px-2 py-1 text-sm"/>
                  <button onClick={() => doOcr(currentIdx)} disabled={loading} className="px-2 py-1 bg-blue-500 text-white rounded text-sm"><Icon name="scan" className="w-4 h-4"/></button>
                </div>
                <label className="block text-sm font-medium mb-1">ÂÖÖÊîæÈõªÂõûÊï∞</label>
                <input type="text" value={cur.cycle_count || ''} onChange={e => { const np = [...products]; np[currentIdx].cycle_count = e.target.value; setProducts(np); }} className="w-full border rounded px-2 py-1 text-sm mb-3"/>
                <label className="block text-sm font-medium mb-1">„Éê„ÉÉ„ÉÜ„É™„Éº(%)</label>
                <input type="text" value={cur.battery_health || ''} onChange={e => { const np = [...products]; np[currentIdx].battery_health = e.target.value; setProducts(np); }} className="w-full border rounded px-2 py-1 text-sm mb-4"/>
                
                <hr className="my-3"/>
                <p className="text-xs text-gray-500 mb-2">„ÇØ„Ç§„ÉÉ„ÇØÁµêÂêà</p>
                <button onClick={async () => {
                  const active = cur.images.filter(img => !img.excluded);
                  if (active.length < 3) return alert('ÁµêÂêà„Å´„ÅØ3Êûö‰ª•‰∏äÂøÖË¶ÅÔºà„Éê„Éº„Ç≥„Éº„ÉâÈô§„ÅèÔºâ');
                  saveHistory();
                  const toMerge = active.slice(0, 2);
                  const { dataUrl, filename } = await mergeImages(toMerge, 2);
                  const np = [...products];
                  const newImg = { id: `merged_${Date.now()}`, filename, dataUrl, excluded: false };
                  const mergedIds = toMerge.map(img => img.id);
                  // ÂÖÉ„ÅÆ‰ΩçÁΩÆÔºàÊúÄÂàù„ÅÆactiveÁîªÂÉè„ÅÆ‰ΩçÁΩÆÔºâ„Å´ÊåøÂÖ•
                  const firstIdx = cur.images.findIndex(img => img.id === toMerge[0].id);
                  const newImages = cur.images.map(img => mergedIds.includes(img.id) ? {...img, excluded: true} : img);
                  newImages.splice(firstIdx, 0, newImg);
                  np[currentIdx].images = newImages;
                  setProducts(np);
                }} className="w-full mb-2 px-2 py-1 bg-orange-500 text-white rounded text-sm">ÂÖàÈ†≠2Êûö‚Üí1Êûö</button>
                <button onClick={async () => {
                  const active = cur.images.filter(img => !img.excluded);
                  if (active.length < 5) return alert('ÁµêÂêà„Å´„ÅØ5Êûö‰ª•‰∏äÂøÖË¶ÅÔºà„Éê„Éº„Ç≥„Éº„ÉâÈô§„ÅèÔºâ');
                  saveHistory();
                  const toMerge = active.slice(0, 4);
                  const { dataUrl, filename } = await mergeImages(toMerge, 2);
                  const np = [...products];
                  const newImg = { id: `merged_${Date.now()}`, filename, dataUrl, excluded: false };
                  const mergedIds = toMerge.map(img => img.id);
                  // ÂÖÉ„ÅÆ‰ΩçÁΩÆÔºàÊúÄÂàù„ÅÆactiveÁîªÂÉè„ÅÆ‰ΩçÁΩÆÔºâ„Å´ÊåøÂÖ•
                  const firstIdx = cur.images.findIndex(img => img.id === toMerge[0].id);
                  const newImages = cur.images.map(img => mergedIds.includes(img.id) ? {...img, excluded: true} : img);
                  newImages.splice(firstIdx, 0, newImg);
                  np[currentIdx].images = newImages;
                  setProducts(np);
                }} className="w-full mb-2 px-2 py-1 bg-orange-500 text-white rounded text-sm">ÂÖàÈ†≠4Êûö‚Üí1Êûö</button>
                
                {imageHistory.length > 0 && (
                  <button onClick={undoMerge} className="w-full px-2 py-1 bg-yellow-500 text-white rounded text-sm">‚Ü© Êàª„Åô ({imageHistory.length})</button>
                )}
              </div>
            </div>

            <div className="border-t p-4 flex justify-between">
              <button onClick={() => setStep(1)} className="px-4 py-2 border rounded hover:bg-gray-50">Êàª„Çã</button>
              <button onClick={processProducts} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Ê¨°„Å∏</button>
            </div>
          </div>
          );
        })()}

        {/* Step 3: ‰æ°Ê†ºÁ¢∫Ë™ç */}
        {step === 3 && (
          <div className="bg-white rounded shadow p-4">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-bold">‰æ°Ê†ºÁ¢∫Ë™ç</h2>
              <span className="text-xs text-gray-500">üí° ‰æ°Ê†ºExcelÊú™Ë®≠ÂÆöÊôÇ„ÅØ‰ªïÂÖ•Âéü‰æ°„Åã„ÇâËá™ÂãïË®àÁÆóÔºàÂà©Áõä20%+ÊâãÊï∞Êñô10%+ÈÄÅÊñô¬•1,500+Ê¢±ÂåÖ¬•1,000Ôºâ</span>
            </div>
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-3 py-2 text-left">„Éï„Ç©„É´„ÉÄ</th>
                  <th className="px-3 py-2 text-left">BCÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ∑®ÈõÜÔºâ</th>
                  <th className="px-3 py-2 text-left">ÂïÜÂìÅ</th>
                  <th className="px-3 py-2 text-right">‰ªïÂÖ•</th>
                  <th className="px-3 py-2 text-right">Ë≤©Â£≤‰æ°Ê†º</th>
                  <th className="px-3 py-2 text-center">Áõ∏Â†¥</th>
                  <th className="px-3 py-2">Áä∂ÊÖã</th>
                </tr>
              </thead>
              <tbody>
                {products.map((p, i) => {
                  const activeImgs = p.images.filter(img => !img.excluded);
                  const bcImg = activeImgs.length > 0 ? activeImgs[activeImgs.length - 1] : null;
                  const hasPrice = p.price && p.price > 0;
                  const profit = hasPrice && p.purchaseCost ? p.price - Math.round(p.price * 0.1) - 1500 - 1000 - p.purchaseCost : null;
                  const profitRate = profit && p.price ? Math.round(profit / p.price * 100) : null;
                  const rowBg = p.status !== 'ok' ? 'bg-red-50' : (!hasPrice ? 'bg-yellow-50' : (i % 2 ? 'bg-gray-50' : ''));
                  return (
                  <tr key={p.id} className={rowBg}>
                    <td className="px-3 py-2">{p.folder}</td>
                    <td className="px-3 py-2">
                      <div className="flex items-center gap-2">
                        {bcImg && (
                          <img 
                            src={bcImg.dataUrl} 
                            className="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-80 border"
                            onClick={() => { setCurrentIdx(i); setZoomImage(bcImg.dataUrl); }}
                            title="„ÇØ„É™„ÉÉ„ÇØ„ÅßÊã°Â§ß„ÉªÁ∑®ÈõÜ"
                          />
                        )}
                        <span className={`font-mono ${p.barcode ? '' : 'text-gray-400'}`}>{p.barcode || 'Êú™ÂÖ•Âäõ'}</span>
                      </div>
                    </td>
                    <td className="px-3 py-2">{p.specs?.maker} {p.specs?.product_name}</td>
                    <td className="px-3 py-2 text-right text-gray-500">
                      {p.purchaseCost ? `¬•${p.purchaseCost.toLocaleString()}` : '-'}
                    </td>
                    <td className="px-3 py-2 text-right">
                      <div className="flex items-center justify-end gap-1">
                        <input type="number" value={p.price || ''} onChange={e => { const np = [...products]; np[i].price = parseInt(e.target.value) || null; setProducts(np); }} placeholder="999999" className={`w-24 border rounded px-2 py-1 text-right ${!hasPrice ? 'border-yellow-400 bg-yellow-50' : ''}`}/>
                      </div>
                      {profit !== null && (
                        <div className={`text-xs mt-0.5 ${profit > 0 ? 'text-green-600' : 'text-red-500'}`}>
                          Âà©Áõä ¬•{profit.toLocaleString()} ({profitRate}%)
                        </div>
                      )}
                    </td>
                    <td className="px-2 py-2 text-center">
                      {p.status === 'ok' && (() => {
                        const q = buildSearchQuery(p);
                        return q ? (
                          <div className="flex gap-1 justify-center">
                            <a href={buildYahooUrl(q)} target="_blank" rel="noopener" className="px-1.5 py-0.5 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200" title={`„É§„Éï„Ç™„ÇØ: ${q}`}>Y!</a>
                            <a href={buildMercariUrl(q)} target="_blank" rel="noopener" className="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200" title={`„É°„É´„Ç´„É™: ${q}`}>M</a>
                          </div>
                        ) : null;
                      })()}
                    </td>
                    <td className="px-3 py-2 text-center">
                      {p.status !== 'ok' ? (
                        <Icon name="x" className="w-5 h-5 text-red-400 mx-auto" title="„Éá„Éº„Çø„Å™„Åó"/>
                      ) : hasPrice ? (
                        <Icon name="check" className="w-5 h-5 text-green-500 mx-auto" title="OK"/>
                      ) : (
                        <span className="text-yellow-500 font-bold" title="‰æ°Ê†º„Å™„ÅóÔºà999999„ÅßÂá∫ÂäõÔºâ">‚ö†</span>
                      )}
                    </td>
                  </tr>
                  );
                })}
              </tbody>
            </table>
            <div className="flex justify-between mt-4">
              <button onClick={() => setStep(2)} className="px-4 py-2 border rounded">Êàª„Çã</button>
              <div className="flex gap-2">
                <button onClick={processProducts} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ÂÜçÁÖßÂêà</button>
                <button onClick={goToPreview} disabled={loading} className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50">
                  {loading ? 'Âá¶ÁêÜ‰∏≠...' : '„Éó„É¨„Éì„É•„Éº ‚Üí'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Step 4: „Éó„É¨„Éì„É•„ÉºÁ∑®ÈõÜ */}
        {step === 4 && (() => {
          const okProducts = products.filter(p => p.barcode);
          const cur = okProducts[currentIdx] || null;
          const curProductIdx = cur ? products.findIndex(p => p.id === cur.id) : -1;
          const activeImgs = cur ? cur.images.filter((img, i) => i < cur.images.length - 1 && !img.excluded) : [];
          
          // ÁîªÂÉèÂÖ•„ÇåÊõø„ÅàÈñ¢Êï∞
          const swapImages = (fromIdx, toIdx) => {
            if (curProductIdx < 0) return;
            const np = [...products];
            const imgs = [...np[curProductIdx].images];
            // activeImgs„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂÆüÈöõ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å´Â§âÊèõ
            const activeToReal = [];
            let ai = 0;
            imgs.forEach((img, i) => {
              if (i < imgs.length - 1 && !img.excluded) {
                activeToReal[ai] = i;
                ai++;
              }
            });
            const realFrom = activeToReal[fromIdx];
            const realTo = activeToReal[toIdx];
            if (realFrom !== undefined && realTo !== undefined) {
              [imgs[realFrom], imgs[realTo]] = [imgs[realTo], imgs[realFrom]];
              np[curProductIdx].images = imgs;
              setProducts(np);
            }
          };
          
          return (
          <div className="bg-white rounded shadow">
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-bold">„Éó„É¨„Éì„É•„ÉºÁ∑®ÈõÜ</h2>
              <div className="flex items-center gap-4">
                <span className="text-sm text-gray-600">{okProducts.length}ÂïÜÂìÅ</span>
                <button onClick={() => setStep(3)} className="px-3 py-1 border rounded text-sm">Êàª„Çã</button>
                <button onClick={generateCsv} disabled={loading} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50">
                  {loading ? 'Âá¶ÁêÜ‰∏≠...' : 'CSVÁîüÊàê'}
                </button>
              </div>
            </div>
            
            <div className="flex" style={{height: 'calc(100vh - 220px)'}}>
              {/* ÂïÜÂìÅ„É™„Çπ„Éà */}
              <div className="w-48 border-r bg-gray-50 overflow-y-auto">
                {okProducts.map((p, i) => (
                  <button 
                    key={p.id} 
                    onClick={() => setCurrentIdx(i)} 
                    className={`w-full text-left px-3 py-2 text-sm border-b ${i === currentIdx ? 'bg-blue-500 text-white' : 'hover:bg-gray-100'}`}
                  >
                    <div className="font-medium truncate">{p.specs?.maker || 'Unknown'}</div>
                    <div className="text-xs opacity-75 truncate">{p.barcode}</div>
                  </button>
                ))}
              </div>
              
              {/* Á∑®ÈõÜ„Ç®„É™„Ç¢ */}
              {cur && (
                <div className="flex-1 overflow-y-auto p-4">
                  {/* ÁîªÂÉè„Éó„É¨„Éì„É•„ÉºÔºàÂÖ•„ÇåÊõø„Åà„ÉªÊã°Â§ßÂèØËÉΩÔºâ */}
                  <div className="mb-4">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-sm font-medium">üì∑ Âá∫ÂìÅÁîªÂÉè</span>
                      <span className="text-xs text-gray-500">„Éâ„É©„ÉÉ„Ç∞„ÅßÂÖ•„ÇåÊõø„Åà / „ÇØ„É™„ÉÉ„ÇØ„ÅßÊã°Â§ß</span>
                    </div>
                    <div className="flex gap-2 overflow-x-auto pb-2">
                      {activeImgs.slice(0, 10).map((img, i) => (
                        <div 
                          key={i}
                          draggable
                          onDragStart={e => e.dataTransfer.setData('text/plain', i.toString())}
                          onDragOver={e => e.preventDefault()}
                          onDrop={e => {
                            e.preventDefault();
                            const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                            if (fromIdx !== i) swapImages(fromIdx, i);
                          }}
                          className="relative flex-shrink-0 cursor-move"
                        >
                          <img 
                            src={img.dataUrl} 
                            className="w-20 h-20 object-cover rounded border hover:border-blue-400"
                            onClick={() => setZoomImage(img.dataUrl)}
                          />
                          <span className="absolute bottom-0 left-0 bg-black/60 text-white text-xs px-1 rounded-tr">{i+1}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* „Çø„Ç§„Éà„É´ */}
                  <div className="mb-4">
                    <div className="flex items-center justify-between mb-1">
                      <label className="font-medium text-sm">„Çø„Ç§„Éà„É´</label>
                      <span className={`text-xs ${(cur.title || '').length > 65 ? 'text-red-500' : 'text-gray-500'}`}>
                        {(cur.title || '').length}/65
                      </span>
                    </div>
                    <input 
                      type="text" 
                      value={cur.title || ''} 
                      onChange={e => { 
                        const np = [...products]; 
                        const idx = np.findIndex(p => p.id === cur.id);
                        if (idx >= 0) np[idx].title = e.target.value;
                        setProducts(np); 
                      }} 
                      className={`w-full border rounded px-3 py-2 ${(cur.title || '').length > 65 ? 'border-red-400' : ''}`}
                    />
                  </div>
                  
                  {/* ‰æ°Ê†º */}
                  <div className="mb-4">
                    <label className="font-medium text-sm block mb-1">‰æ°Ê†º</label>
                    <input 
                      type="number" 
                      value={cur.price || ''} 
                      onChange={e => { 
                        const np = [...products]; 
                        const idx = np.findIndex(p => p.id === cur.id);
                        if (idx >= 0) np[idx].price = parseInt(e.target.value) || null;
                        setProducts(np); 
                      }} 
                      placeholder="999999"
                      className="w-32 border rounded px-3 py-2"
                    />
                    {!cur.price && <span className="ml-2 text-yellow-600 text-sm">‚ö† ‰æ°Ê†ºÊú™Ë®≠ÂÆöÔºà999999„ÅßÂá∫ÂäõÔºâ</span>}
                  </div>
                  
                  {/* ÂïÜÂìÅË™¨Êòé */}
                  <div>
                    <label className="font-medium text-sm block mb-1">ÂïÜÂìÅË™¨Êòé</label>
                    <textarea 
                      value={cur.description || ''} 
                      onChange={e => { 
                        const np = [...products]; 
                        const idx = np.findIndex(p => p.id === cur.id);
                        if (idx >= 0) np[idx].description = e.target.value;
                        setProducts(np); 
                      }} 
                      rows={20}
                      className="w-full border rounded px-3 py-2 text-sm font-mono"
                    />
                  </div>
                </div>
              )}
            </div>
          </div>
          );
        })()}

        {/* Step 5: ÂÆå‰∫Ü */}
        {step === 5 && (
          <div className="bg-white rounded shadow p-8 text-center">
            <Icon name="check" className="w-16 h-16 text-green-500 mx-auto mb-4"/>
            <h2 className="text-xl font-bold mb-2">ÂÆå‰∫ÜÔºÅ</h2>
            <p className="text-gray-600 mb-6">{message}</p>
            <button onClick={() => { setStep(1); setProducts([]); }} className="text-blue-500 hover:underline">Êñ∞Ë¶è‰ΩúÊàê</button>
          </div>
        )}
      </div>

      {/* ‰øùË®ºÊñá„Ç®„Éá„Ç£„Çø */}
      {showNoticeEditor && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowNoticeEditor(false)}>
          <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[85vh] overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b flex items-center justify-between">
              <h3 className="font-bold text-lg">üìù ‰øùË®ºÊñá„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ</h3>
              <button onClick={() => setShowNoticeEditor(false)} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div className="p-4">
              <textarea
                value={noticeText}
                onChange={e => setNoticeText(e.target.value)}
                rows={18}
                className="w-full border rounded px-3 py-2 text-sm font-mono"
              />
              <div className="flex justify-between mt-3">
                <button onClick={() => { setNoticeText(DEFAULT_NOTICE_TEXT); }} className="px-3 py-1 border rounded text-sm hover:bg-gray-50">„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
                <div className="flex gap-2">
                  <button onClick={() => setShowNoticeEditor(false)} className="px-4 py-2 border rounded">„Ç≠„É£„É≥„Çª„É´</button>
                  <button onClick={() => { localStorage.setItem('mercari_notice_text', noticeText); setShowNoticeEditor(false); setMessage('‚úÖ ‰øùË®ºÊñá„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); }} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">‰øùÂ≠ò</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {loading && (
        <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
          <div className="bg-white rounded p-6 flex items-center gap-3">
            <Icon name="refresh" className="w-6 h-6 animate-spin text-blue-500"/>Âá¶ÁêÜ‰∏≠...
          </div>
        </div>
      )}

      {/* ÁîªÂÉèÊã°Â§ß„É¢„Éº„ÉÄ„É´ */}
      {zoomImage && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setZoomImage(null)}>
          <div className="relative max-w-5xl w-full max-h-[90vh]" onClick={e => e.stopPropagation()}>
            {/* Èñâ„Åò„Çã„Éú„Çø„É≥ */}
            <button onClick={() => setZoomImage(null)} className="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">&times;</button>
            
            {/* ÁîªÂÉè */}
            <img src={zoomImage} className="w-full h-auto rounded-lg" style={{maxHeight: '75vh', objectFit: 'contain'}}/>
            
            {/* „Éê„Éº„Ç≥„Éº„ÉâÂÖ•ÂäõÔºà‰∏ãÈÉ®Ôºâ */}
            <div className="mt-4 bg-white rounded-lg p-4 flex items-center gap-4">
              <label className="font-medium whitespace-nowrap">„Éê„Éº„Ç≥„Éº„ÉâÁï™Âè∑:</label>
              <input 
                type="text" 
                value={products[currentIdx]?.barcode || ''} 
                onChange={e => { 
                  const np = [...products]; 
                  np[currentIdx].barcode = e.target.value; 
                  setProducts(np); 
                }} 
                placeholder="‰∏ã6Ê°Å„ÇíÂÖ•ÂäõÔºà‰æã: 185660Ôºâ"
                className="flex-1 border-2 border-blue-400 rounded px-3 py-2 text-lg font-mono focus:border-blue-600 focus:outline-none"
              />
              <button 
                onClick={() => setZoomImage(null)} 
                className="px-6 py-2 bg-blue-500 text-white rounded font-medium hover:bg-blue-600"
              >
                OK
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ÂÜôÁúüÊåØ„ÇäÂàÜ„Åë„É¢„Éº„Éâ */}
      {sorterMode && (() => {
        const groups = sorterGetGroups();
        const currentGroup = groups.find(g => sorterSelected >= g.start && sorterSelected < g.end);
        return (
        <div className="sorter-overlay" onKeyDown={e => {
          if (sorterPreview) {
            if (e.key === 'Escape' || e.key === ' ') { e.preventDefault(); setSorterPreview(null); }
            else if (e.key === 'ArrowLeft' && sorterSelected > 0) { e.preventDefault(); setSorterSelected(s => s-1); setSorterPreview(sorterPhotos[sorterSelected-1]?.dataUrl); }
            else if (e.key === 'ArrowRight' && sorterSelected < sorterPhotos.length-1) { e.preventDefault(); setSorterSelected(s => s+1); setSorterPreview(sorterPhotos[sorterSelected+1]?.dataUrl); }
            return;
          }
          if (e.key === 'ArrowRight') { e.preventDefault(); setSorterSelected(s => Math.min(sorterPhotos.length-1, s+1)); }
          else if (e.key === 'ArrowLeft') { e.preventDefault(); setSorterSelected(s => Math.max(0, s-1)); }
          else if (e.key === 's' || e.key === 'S') { e.preventDefault(); sorterToggleSplit(); }
          else if (e.key === 'z' || e.key === 'Z') { e.preventDefault(); sorterUndoSplit(); }
          else if (e.key === ' ') { e.preventDefault(); if (sorterSelected >= 0) setSorterPreview(sorterPhotos[sorterSelected]?.dataUrl); }
          else if (e.key === 'Escape') { if (confirm('ÊåØ„ÇäÂàÜ„Åë„Çí‰∏≠Ê≠¢„Åó„Åæ„Åô„ÅãÔºü')) setSorterMode(false); }
        }} tabIndex={0} ref={el => el && el.focus()}>
          <div className="sorter-header">
            <h2>üì∑ ÂÜôÁúüÊåØ„ÇäÂàÜ„Åë„É¢„Éº„Éâ</h2>
            <div className="sorter-stats">
              <div className="sorter-stat">ÂÜôÁúü: <b>{sorterPhotos.length}</b></div>
              <div className="sorter-stat">PCÊï∞: <b>{groups.length}</b></div>
              {currentGroup && <div className="sorter-stat">ÁèæÂú®: <b>{currentGroup.count}</b>Êûö</div>}
            </div>
          </div>
          <div className="sorter-toolbar">
            <button className="sbtn sbtn-split" onClick={sorterToggleSplit}>‚úÇ „Åì„Åì„ÅßÂå∫Âàá„Çã (S)</button>
            <button className="sbtn sbtn-undo" onClick={sorterUndoSplit}>‚Ü© Êàª„Åô (Z)</button>
            <button className="sbtn sbtn-done" onClick={sorterFinish} disabled={sorterSplits.size === 0}>
              ‚úÖ ÊåØ„ÇäÂàÜ„ÅëÂÆå‰∫Ü ({groups.length}Âè∞)
            </button>
            <button className="sbtn sbtn-cancel" onClick={() => { if(confirm('‰∏≠Ê≠¢„Åó„Åæ„Åô„ÅãÔºü')) setSorterMode(false); }}>‚úï ‰∏≠Ê≠¢</button>
            <div className="sorter-keys">
              <kbd>S</kbd> Âå∫Âàá„Çã <kbd>Z</kbd> Êàª„Åô <kbd>Space</kbd> „Éó„É¨„Éì„É•„Éº <kbd>‚Üê‚Üí</kbd> ÁßªÂãï
            </div>
          </div>
          <div style={{display:'flex', flex:1, overflow:'hidden'}}>
            {/* PC‰∏ÄË¶ß„Çµ„Ç§„Éâ„Éê„Éº */}
            <div className="sorter-sidebar">
              {groups.map((g, i) => (
                <div key={i}
                  className={`sorter-pc-item ${currentGroup === g ? 's-active' : ''}`}
                  onClick={() => setSorterSelected(g.start)}>
                  <span>PC {i+1}</span><span style={{color:'#888',fontSize:12}}>{g.count}Êûö</span>
                </div>
              ))}
            </div>
            {/* ÂÜôÁúü„Ç∞„É™„ÉÉ„Éâ */}
            <div className="sorter-grid">
              {sorterPhotos.map((photo, i) => {
                const isSplit = sorterSplits.has(i);
                const isNextSplit = sorterSplits.has(i + 1);
                const isSelected = i === sorterSelected;
                // PCÂå∫Âàá„Çä„Éò„ÉÉ„ÉÄ„Éº
                const groupIdx = groups.findIndex(g => g.start === i);
                return (
                  <React.Fragment key={photo.id}>
                    {(i === 0 || isSplit) && (
                      <div className="sorter-divider">
                        <span>PC {groupIdx >= 0 ? groupIdx + 1 : '?'}</span>
                        <span>{groups[groupIdx]?.count || 0}Êûö</span>
                      </div>
                    )}
                    <div
                      className={`sorter-item ${isSelected ? 's-selected' : ''} ${isNextSplit ? 's-split' : ''}`}
                      onClick={() => setSorterSelected(i)}
                      onDoubleClick={() => setSorterPreview(photo.dataUrl)}
                      draggable
                      onDragStart={e => e.dataTransfer.setData('text/plain', i.toString())}
                      onDragOver={e => e.preventDefault()}
                      onDrop={e => {
                        e.preventDefault();
                        const from = parseInt(e.dataTransfer.getData('text/plain'));
                        if (from === i) return;
                        setSorterPhotos(prev => {
                          const arr = [...prev];
                          const [moved] = arr.splice(from, 1);
                          arr.splice(i, 0, moved);
                          return arr;
                        });
                        // splitPoints„ÇÇË™øÊï¥
                        setSorterSplits(prev => {
                          const newSplits = new Set();
                          Array.from(prev).sort((a,b)=>a-b).forEach(sp => {
                            let ns = sp;
                            if (from < i) { if(sp > from && sp <= i) ns=sp-1; else if(sp===from) ns=i; }
                            else { if(sp >= i && sp < from) ns=sp+1; else if(sp===from) ns=i; }
                            if(ns > 0 && ns < sorterPhotos.length) newSplits.add(ns);
                          });
                          return newSplits;
                        });
                        setSorterSelected(i);
                      }}
                    >
                      <img src={photo.dataUrl} loading="lazy"/>
                      <div className="s-label">{photo.filename.replace(/\.[^.]+$/, '').replace('IMG_', '')}</div>
                    </div>
                  </React.Fragment>
                );
              })}
            </div>
          </div>

          {/* „Éó„É¨„Éì„É•„Éº */}
          {sorterPreview && (
            <div className="sorter-preview active" onClick={() => setSorterPreview(null)}>
              <img src={sorterPreview}/>
            </div>
          )}
        </div>
        );
      })()}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
